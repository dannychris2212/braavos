<!DOCTYPE html>

<html lang="pt-BR">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Braavos â€” Sales Intelligence</title>
<link rel="preconnect" href="https://fonts.googleapis.com"/>
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Outfit:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet"/>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<!-- PWA -->
<link rel="manifest" href="/manifest.json"/>
<link rel="icon" href="/icon.svg" type="image/svg+xml"/>
<link rel="apple-touch-icon" href="/icon.svg"/>
<meta name="apple-mobile-web-app-capable" content="yes"/>
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"/>
<meta name="apple-mobile-web-app-title" content="Braavos"/>
<meta name="mobile-web-app-capable" content="yes"/>
<meta name="theme-color" content="#c9a84c"/>
<meta name="msapplication-TileColor" content="#0a0a0f"/>
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
/* LIGHT MODE */
body.light{
  --bs:rgba(0,0,0,0.05);--bs2:rgba(0,0,0,0.08);
  --bb:rgba(0,0,0,0.10);--bb2:rgba(0,0,0,0.18);
  --txt:#1a1a2e;--muted:rgba(26,26,46,0.5);
  --bg:#f2f2f7;--bg2:#e8e8f0;
  background:#f2f2f7 !important;
}
body.light .sidebar{background:rgba(255,255,255,0.85);border-color:var(--bb)}
body.light .card{background:rgba(255,255,255,0.9);border-color:var(--bb)}
body.light .modal{background:#ffffff}
body.light .dp{background:#f8f8fc}
body.light .nav:hover{background:rgba(0,0,0,0.04)}
body.light .nav.active{background:rgba(0,0,0,0.07)}
body.light .linp,.light .fi,.light .fs,.light .fta{background:rgba(0,0,0,0.04);border-color:var(--bb);color:var(--txt)}
body.light .fs option{background:#fff}
body.light .topbar{background:rgba(244,244,248,0.95)}
body.light .login-box{background:rgba(255,255,255,0.9)}
body.light .s-user{background:rgba(0,0,0,0.04)}
body.light .toast{background:rgba(255,255,255,0.97)}
body.light .chip{background:rgba(0,0,0,0.04);border-color:var(--bb);color:var(--muted)}
body.light .chip.on{background:var(--dim);border-color:var(--brand);color:var(--brand)}
body.light .fsearch{background:rgba(0,0,0,0.04);border-color:var(--bb);color:var(--txt)}
body.light .acard{background:rgba(255,255,255,0.9);border-color:var(--bb)}
body.light .f-stage{background:rgba(255,255,255,0.8);border-color:var(--bb)}
body.light .ped-card{border-color:var(--bb)}
:root{
  --bs:rgba(255,255,255,0.04);--bs2:rgba(255,255,255,0.07);
  --bb:rgba(255,255,255,0.08);--bb2:rgba(255,255,255,0.14);
  --gold:#c9a84c;--txt:#f0f0f8;--muted:rgba(240,240,248,0.45);
  --ok:#4fc87a;--warn:#f0a050;--err:#f05050;
  --FD:'Bebas Neue',sans-serif;--FB:'Outfit',sans-serif;--FM:'JetBrains Mono',monospace;
  --r:16px;--rs:10px;--rl:24px;
  --brand:#c9a84c;--dim:rgba(201,168,76,0.12);--bg:#0a0a0f;--bg2:#0f0f1a;
}
.t-braavos  {--brand:#c9a84c;--dim:rgba(201,168,76,0.12);--bg:#0a0a0f;--bg2:#0f0f1a}
.t-techwave {--brand:#0ea5e9;--dim:rgba(14,165,233,0.12);--bg:#070d14;--bg2:#0a1520}
.t-logistica{--brand:#f97316;--dim:rgba(249,115,22,0.12);--bg:#0f0a06;--bg2:#1a1008}
.t-fintech  {--brand:#10b981;--dim:rgba(16,185,129,0.12);--bg:#060f0a;--bg2:#081a10}
.t-saude    {--brand:#a855f7;--dim:rgba(168,85,247,0.12);--bg:#0c0714;--bg2:#130d1f}

html,body{height:100%;overflow:hidden}
body{font-family:var(â€“FB);color:var(â€“txt);background:var(â€“bg)}
body::before{content:â€™â€™;position:fixed;inset:0;background-image:url(â€œdata:image/svg+xml,%3Csvg viewBox=â€˜0 0 200 200â€™ xmlns=â€˜http://www.w3.org/2000/svgâ€™%3E%3Cfilter id=â€˜nâ€™%3E%3CfeTurbulence type=â€˜fractalNoiseâ€™ baseFrequency=â€˜0.85â€™ numOctaves=â€˜4â€™ stitchTiles=â€˜stitchâ€™/%3E%3C/filter%3E%3Crect width=â€˜100%25â€™ height=â€˜100%25â€™ filter=â€˜url(%23n)â€™ opacity=â€˜0.035â€™/%3E%3C/svg%3Eâ€);pointer-events:none;z-index:999;opacity:0.5}

/* â”€â”€ LOGIN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#login-screen{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:var(â€“bg);z-index:500;transition:opacity .4s}
#login-screen.hidden{opacity:0;pointer-events:none}
.login-box{width:360px;background:rgba(255,255,255,0.04);border:1px solid var(â€“bb);border-radius:var(â€“rl);padding:40px;backdrop-filter:blur(16px);position:relative;overflow:hidden}
.login-box::before{content:â€™â€™;position:absolute;top:0;left:0;right:0;height:1px;background:linear-gradient(90deg,transparent,rgba(255,255,255,0.1),transparent)}
.login-logo{font-family:var(â€“FD);font-size:40px;letter-spacing:.1em;text-transform:uppercase;margin-bottom:4px}
.login-sub{font-family:var(â€“FM);font-size:10px;letter-spacing:.2em;color:var(â€“muted);text-transform:uppercase;margin-bottom:28px}
.lbl{font-size:11px;color:var(â€“muted);margin-bottom:5px;font-family:var(â€“FM);letter-spacing:.1em;text-transform:uppercase}
.linp{width:100%;padding:10px 13px;background:rgba(255,255,255,0.05);border:1px solid var(â€“bb);border-radius:var(â€“rs);color:var(â€“txt);font-family:var(â€“FB);font-size:14px;outline:none;transition:border-color .2s;margin-bottom:14px}
.linp:focus{border-color:var(â€“brand)}.linp::placeholder{color:var(â€“muted)}
.lbtn{width:100%;padding:11px;background:var(â€“brand);color:#fff;border:none;border-radius:99px;font-family:var(â€“FB);font-size:14px;font-weight:600;cursor:pointer;transition:opacity .2s;margin-top:4px}
.lbtn:hover{opacity:.88}.lbtn:disabled{opacity:.45;cursor:not-allowed}
.lerr{font-size:12px;color:var(â€“err);font-family:var(â€“FM);text-align:center;margin-top:10px;min-height:16px}

/* â”€â”€ LAYOUT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.orb{position:fixed;border-radius:50%;filter:blur(90px);pointer-events:none}
.orb1{width:500px;height:500px;top:-150px;left:-100px;background:radial-gradient(circle,var(â€“dim),transparent 70%);animation:o1 14s ease-in-out infinite alternate}
.orb2{width:400px;height:400px;bottom:-100px;right:-80px;background:radial-gradient(circle,var(â€“dim),transparent 70%);animation:o2 18s ease-in-out infinite alternate}
@keyframes o1{from{transform:translate(0,0)}to{transform:translate(50px,30px)}}
@keyframes o2{from{transform:translate(0,0)}to{transform:translate(-40px,-50px)}}
.app{display:flex;height:100vh;overflow:hidden;position:relative}

/* â”€â”€ SIDEBAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.sidebar{width:220px;height:100vh;background:rgba(255,255,255,0.025);border-right:1px solid var(â€“bb);backdrop-filter:blur(16px);display:flex;flex-direction:column;padding:24px 0;flex-shrink:0;position:fixed;left:0;top:0;z-index:15;transition:transform .3s cubic-bezier(.4,0,.2,1)}
.s-logo{padding:0 22px 22px;font-family:var(â€“FD);font-size:30px;letter-spacing:.1em;text-transform:uppercase;border-bottom:1px solid var(â€“bb);margin-bottom:10px}
.s-logo .sg{color:var(â€“gold)}.s-logo .sr{color:var(â€“brand)}
.s-logo small{display:block;font-family:var(â€“FM);font-size:9px;letter-spacing:.15em;color:var(â€“muted);text-transform:uppercase;margin-top:3px}
.nav{display:flex;align-items:center;gap:10px;padding:10px 22px;color:var(â€“muted);cursor:pointer;font-size:13.5px;border-left:2px solid transparent;transition:all .2s;user-select:none;position:relative}
.nav:hover{color:var(â€“txt);background:rgba(255,255,255,0.03)}
.nav.active{color:var(â€“txt);background:rgba(255,255,255,0.05);border-left-color:var(â€“brand);font-weight:500}
.nav-ic{font-size:15px;width:20px;text-align:center;flex-shrink:0;font-style:normal}
.nbadge{margin-left:auto;min-width:18px;height:18px;border-radius:99px;background:var(â€“err);color:#fff;font-size:10px;font-family:var(â€“FM);font-weight:700;padding:0 5px;display:inline-flex;align-items:center;justify-content:center}
.nbadge.hide{display:none}
.nav-spacer{flex:1}
.s-user{margin:0 10px;padding:12px;background:var(â€“bs);border:1px solid var(â€“bb);border-radius:var(â€“rs)}
.s-user-name{font-size:13px;font-weight:500;margin-bottom:2px}
.s-user-role{font-family:var(â€“FM);font-size:10px;color:var(â€“brand);letter-spacing:.08em;text-transform:uppercase}
.s-logout{font-family:var(â€“FM);font-size:10px;color:var(â€“muted);cursor:pointer;margin-top:7px;display:inline-block;transition:color .2s}
.s-logout:hover{color:var(â€“err)}

/* â”€â”€ MOBILE TOPBAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.topbar{display:none;position:fixed;top:0;left:0;right:0;height:54px;background:rgba(10,10,15,.95);backdrop-filter:blur(20px);border-bottom:1px solid var(â€“bb);z-index:20;align-items:center;padding:0 16px;gap:12px}
.burger{background:none;border:none;color:var(â€“txt);cursor:pointer;padding:6px;display:flex;flex-direction:column;gap:5px}
.burger span{display:block;width:21px;height:2px;background:currentColor;border-radius:2px;transition:all .3s}
.burger.open span:nth-child(1){transform:translateY(7px) rotate(45deg)}
.burger.open span:nth-child(2){opacity:0}
.burger.open span:nth-child(3){transform:translateY(-7px) rotate(-45deg)}
.t-logo{font-family:var(â€“FD);font-size:22px;letter-spacing:.1em;text-transform:uppercase;flex:1}
.t-logo .tg{color:var(â€“gold)}.t-logo .tr{color:var(â€“brand)}
.s-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:12;backdrop-filter:blur(2px);transition:opacity .3s}
.s-overlay.open{opacity:1;pointer-events:all}

/* â”€â”€ MAIN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.main{flex:1;overflow-y:auto;padding:30px 26px;position:relative;z-index:1;margin-left:220px}
::-webkit-scrollbar{width:4px}::-webkit-scrollbar-track{background:transparent}::-webkit-scrollbar-thumb{background:var(â€“bb);border-radius:2px}

/* â”€â”€ PAGE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.page-ey{font-family:var(â€“FM);font-size:10px;letter-spacing:.2em;color:var(â€“brand);text-transform:uppercase;margin-bottom:5px}
.page-ti{font-family:var(â€“FD);font-size:42px;letter-spacing:.08em;text-transform:uppercase;line-height:1;margin-bottom:24px}
.page{animation:pIn .3s ease forwards}
@keyframes pIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}

/* â”€â”€ CARDS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.card{background:var(â€“bs);border:1px solid var(â€“bb);border-radius:var(â€“r);backdrop-filter:blur(16px);padding:20px;transition:border-color .2s,transform .15s;position:relative;overflow:hidden}
.card::before{content:â€™â€™;position:absolute;top:0;left:0;right:0;height:1px;background:linear-gradient(90deg,transparent,rgba(255,255,255,0.08),transparent)}
.card:hover{border-color:var(â€“bb2)}
.card.click{cursor:pointer}.card.click:hover{transform:translateY(-2px);border-color:var(â€“brand)}
.shine::after{content:â€™â€™;position:absolute;inset:0;background:linear-gradient(135deg,rgba(255,255,255,0.03),transparent 60%);pointer-events:none}

/* â”€â”€ GRIDS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.g4{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:14px}
.g3{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-bottom:14px}
.g2{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:14px}

/* â”€â”€ METRIC â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.m-lbl{font-size:10px;color:var(â€“muted);margin-bottom:6px;font-family:var(â€“FM);letter-spacing:.08em;text-transform:uppercase}
.m-val{font-family:var(â€“FD);font-size:42px;line-height:1;letter-spacing:.05em;margin-bottom:3px}
.m-sub{font-size:11px;color:var(â€“muted)}

/* â”€â”€ FUNIL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.funil{display:grid;grid-template-columns:repeat(5,1fr);gap:8px;margin-bottom:18px}
.f-stage{background:var(â€“bs);border:1px solid var(â€“bb);border-radius:var(â€“rs);padding:14px 12px;text-align:center;position:relative;overflow:hidden}
.f-stage::before{content:â€™â€™;position:absolute;top:0;left:0;right:0;height:3px;background:var(â€“sc)}
.f-lbl{font-family:var(â€“FM);font-size:9px;letter-spacing:.12em;text-transform:uppercase;color:var(â€“muted);margin-bottom:8px}
.f-cnt{font-family:var(â€“FD);font-size:34px;color:var(â€“sc);line-height:1;margin-bottom:3px}
.f-sub{font-size:10px;color:var(â€“muted)}

/* â”€â”€ BADGES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.badge{display:inline-flex;align-items:center;padding:2px 9px;border-radius:99px;font-size:10px;font-weight:500;font-family:var(â€“FM);letter-spacing:.06em;text-transform:uppercase}
.b-brand{background:var(â€“dim);border:1px solid var(â€“brand);color:var(â€“brand)}
.b-ok{background:rgba(79,200,122,.12);border:1px solid rgba(79,200,122,.3);color:var(â€“ok)}
.b-warn{background:rgba(240,160,80,.12);border:1px solid rgba(240,160,80,.3);color:var(â€“warn)}
.b-err{background:rgba(240,80,80,.12);border:1px solid rgba(240,80,80,.3);color:var(â€“err)}
.b-dim{background:rgba(255,255,255,.05);border:1px solid var(â€“bb);color:var(â€“muted)}
.b-pur{background:rgba(168,85,247,.12);border:1px solid rgba(168,85,247,.3);color:#a855f7}
.b-blue{background:rgba(14,165,233,.12);border:1px solid rgba(14,165,233,.3);color:#0ea5e9}

/* â”€â”€ ROWS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.row{display:flex;align-items:center;gap:12px;padding:13px 0;border-bottom:1px solid var(â€“bb);cursor:pointer;transition:background .15s}
.row:last-child{border:none;padding-bottom:0}
.row:hover{background:rgba(255,255,255,.02);margin:0 -20px;padding-left:20px;padding-right:20px}
.av{width:36px;height:36px;border-radius:9px;background:var(â€“dim);border:1px solid var(â€“brand);display:flex;align-items:center;justify-content:center;font-family:var(â€“FD);font-size:15px;color:var(â€“brand);flex-shrink:0}
.row-info{flex:1;min-width:0}
.row-name{font-size:14px;font-weight:500;margin-bottom:2px}
.row-sub{font-size:12px;color:var(â€“muted)}
.row-meta{display:flex;gap:6px;align-items:center;flex-shrink:0;flex-wrap:wrap;justify-content:flex-end}

/* â”€â”€ PRIO DOT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.prio{width:7px;height:7px;border-radius:50%;flex-shrink:0}
.p-alta{background:var(â€“err)}.p-media{background:var(â€“warn)}.p-baixa{background:var(â€“ok)}

/* â”€â”€ SECTION HEAD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.sh{display:flex;align-items:center;justify-content:space-between;margin-bottom:14px}
.sh-t{font-family:var(â€“FD);font-size:22px;letter-spacing:.08em;text-transform:uppercase}
.sh-l{font-size:12px;color:var(â€“brand);font-family:var(â€“FM);cursor:pointer}

/* â”€â”€ BTNS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.btn{display:inline-flex;align-items:center;gap:7px;padding:8px 18px;border-radius:99px;font-size:13px;font-weight:500;cursor:pointer;transition:all .2s;font-family:var(â€“FB);border:none;text-decoration:none;white-space:nowrap}
.btn-p{background:var(â€“brand);color:#fff}.btn-p:hover{opacity:.88}
.btn-g{background:var(â€“bs);border:1px solid var(â€“bb);color:var(â€“muted)}.btn-g:hover{color:var(â€“txt);border-color:var(â€“bb2)}
.btn-ok{background:rgba(79,200,122,.15);border:1px solid rgba(79,200,122,.4);color:var(â€“ok)}.btn-ok:hover{background:rgba(79,200,122,.25)}
.btn-err{background:rgba(240,80,80,.12);border:1px solid rgba(240,80,80,.3);color:var(â€“err)}.btn-err:hover{background:rgba(240,80,80,.22)}
.btn-sm{padding:5px 13px;font-size:11px}

/* â”€â”€ FILTER BAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.fbar{display:flex;gap:7px;flex-wrap:wrap;align-items:center;margin-bottom:14px}
.chip{padding:4px 13px;border-radius:99px;border:1px solid var(â€“bb);background:var(â€“bs);color:var(â€“muted);font-size:11px;font-family:var(â€“FM);cursor:pointer;transition:all .2s}
.chip:hover{border-color:var(â€“bb2);color:var(â€“txt)}
.chip.on{border-color:var(â€“brand);color:var(â€“brand);background:var(â€“dim)}
.fsearch{flex:1;min-width:160px;max-width:240px;padding:5px 13px;background:rgba(255,255,255,.04);border:1px solid var(â€“bb);border-radius:99px;color:var(â€“txt);font-family:var(â€“FB);font-size:13px;outline:none;transition:border-color .2s}
.fsearch:focus{border-color:var(â€“brand)}.fsearch::placeholder{color:var(â€“muted)}

/* â”€â”€ PROGRESS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.ptrack{height:5px;border-radius:99px;background:rgba(255,255,255,.06);overflow:hidden}
.pfill{height:100%;border-radius:99px;background:var(â€“brand);transition:width 1s ease}

/* â”€â”€ CONV BARS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.cbar{display:flex;align-items:center;gap:9px;margin-bottom:9px}
.cbar:last-child{margin-bottom:0}
.cbar-lbl{font-family:var(â€“FM);font-size:10px;color:var(â€“muted);width:88px;flex-shrink:0}
.cbar-track{flex:1;height:4px;border-radius:99px;background:rgba(255,255,255,.06);overflow:hidden}
.cbar-fill{height:100%;border-radius:99px;transition:width 1s ease}
.cbar-val{font-family:var(â€“FM);font-size:11px;width:28px;text-align:right;flex-shrink:0}

/* â”€â”€ MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.ov{position:fixed;inset:0;background:rgba(0,0,0,.75);backdrop-filter:blur(4px);z-index:200;display:flex;align-items:center;justify-content:center;opacity:0;pointer-events:none;transition:opacity .2s}
.ov.open{opacity:1;pointer-events:all}
.modal{width:500px;max-height:90vh;overflow-y:auto;background:#0f0f1a;border:1px solid var(â€“bb2);border-radius:var(â€“rl);padding:30px;position:relative;transform:translateY(10px);transition:transform .2s}
.ov.open .modal{transform:translateY(0)}
.modal-ti{font-family:var(â€“FD);font-size:26px;letter-spacing:.08em;text-transform:uppercase;margin-bottom:18px}
.mcl{position:absolute;top:14px;right:14px;background:none;border:none;color:var(â€“muted);cursor:pointer;font-size:17px;transition:color .2s}
.mcl:hover{color:var(â€“txt)}
.fg{margin-bottom:12px}
.fl{font-size:10px;font-family:var(â€“FM);letter-spacing:.1em;text-transform:uppercase;color:var(â€“muted);margin-bottom:5px;display:block}
.fi,.fs,.fta{width:100%;padding:9px 12px;background:rgba(255,255,255,.05);border:1px solid var(â€“bb);border-radius:var(â€“rs);color:var(â€“txt);font-family:var(â€“FB);font-size:13px;outline:none;transition:border-color .2s}
.fi:focus,.fs:focus,.fta:focus{border-color:var(â€“brand)}
.fs option{background:#0f0f1a}.fta{resize:vertical;min-height:70px}
.fr{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.msec{font-family:var(â€“FM);font-size:9px;letter-spacing:.15em;text-transform:uppercase;color:var(â€“muted);margin:16px 0 8px;padding-bottom:5px;border-bottom:1px solid var(â€“bb)}
.mfoot{display:flex;justify-content:flex-end;gap:9px;margin-top:18px}
.check-row{display:flex;align-items:center;gap:10px;padding:10px 13px;background:rgba(79,200,122,.06);border:1px solid rgba(79,200,122,.2);border-radius:var(â€“rs);cursor:pointer;margin-bottom:12px}
.check-row input{width:16px;height:16px;accent-color:var(â€“ok);cursor:pointer}
.check-row label{font-size:13px;cursor:pointer;color:var(â€“ok);font-weight:500}

/* â”€â”€ DETAIL PANEL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.dpov{position:fixed;inset:0;background:rgba(0,0,0,.6);backdrop-filter:blur(4px);z-index:150;opacity:0;pointer-events:none;transition:opacity .2s}
.dpov.open{opacity:1;pointer-events:all}
.dp{position:fixed;right:0;top:0;bottom:0;width:420px;background:#0c0c18;border-left:1px solid var(â€“bb);z-index:160;padding:28px;overflow-y:auto;transform:translateX(100%);transition:transform .3s cubic-bezier(.4,0,.2,1)}
.dp.open{transform:translateX(0)}
.dp-cl{position:absolute;top:14px;right:14px;background:none;border:none;color:var(â€“muted);cursor:pointer;font-size:17px}
.dp-cl:hover{color:var(â€“txt)}
.dp-name{font-family:var(â€“FD);font-size:30px;letter-spacing:.06em;text-transform:uppercase;line-height:1;margin-bottom:3px}
.dp-sub{font-size:13px;color:var(â€“muted);margin-bottom:18px}
.dp-acts{display:flex;gap:7px;margin-bottom:20px;flex-wrap:wrap}
.dp-sec{font-family:var(â€“FM);font-size:9px;letter-spacing:.15em;text-transform:uppercase;color:var(â€“muted);margin:18px 0 10px;padding-bottom:5px;border-bottom:1px solid var(â€“bb)}
.dp-f{margin-bottom:12px}
.dp-fl{font-family:var(â€“FM);font-size:9px;letter-spacing:.15em;text-transform:uppercase;color:var(â€“muted);margin-bottom:3px}
.dp-fv{font-size:13px;line-height:1.5}
.ai-chip{display:inline-flex;align-items:center;gap:5px;padding:3px 10px;border-radius:99px;background:rgba(168,85,247,.1);border:1px solid rgba(168,85,247,.25);color:#c084fc;font-size:10px;font-family:var(â€“FM)}
.ai-chip::before{content:â€˜âœ¦â€™;font-size:9px}
.abox{display:flex;gap:10px;align-items:flex-start;padding:12px;background:rgba(240,160,80,.06);border:1px solid rgba(240,160,80,.2);border-radius:var(â€“rs);margin-bottom:8px}
.abox-ic{font-size:18px;flex-shrink:0}
.abox-ti{font-size:13px;font-weight:500;margin-bottom:1px}
.abox-su{font-size:11px;color:var(â€“muted)}

/* â”€â”€ ALERTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.ag-ti{font-family:var(â€“FD);font-size:20px;letter-spacing:.08em;text-transform:uppercase;margin-bottom:11px;display:flex;align-items:center;gap:8px}
.acard{display:flex;gap:12px;padding:14px;border-radius:var(â€“rs);border:1px solid var(â€“bb);background:var(â€“bs);margin-bottom:9px;cursor:pointer;transition:all .2s;position:relative;overflow:hidden}
.acard::before{content:â€™â€™;position:absolute;left:0;top:0;bottom:0;width:3px;background:var(â€“ac)}
.acard:hover{border-color:var(â€“ac);transform:translateX(3px)}
.acard.lido{opacity:.4}.acard.lido:hover{opacity:.65}
.a-ic{width:38px;height:38px;border-radius:9px;display:flex;align-items:center;justify-content:center;font-style:normal;font-size:16px;flex-shrink:0;background:color-mix(in srgb,var(â€“ac) 12%,transparent);border:1px solid color-mix(in srgb,var(â€“ac) 28%,transparent)}
.a-body{flex:1;min-width:0}
.a-ti{font-size:13px;font-weight:500;margin-bottom:2px}
.a-msg{font-size:12px;color:var(â€“muted);line-height:1.4;overflow:hidden;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical}
.a-ft{display:flex;align-items:center;justify-content:space-between;margin-top:7px}
.a-time{font-family:var(â€“FM);font-size:10px;color:var(â€“muted)}
.a-dot{width:7px;height:7px;border-radius:50%;background:var(â€“ac);flex-shrink:0;animation:pulse 1.5s ease-in-out infinite}

/* ALERT TIPO COLORS */
.ac-pedido_fechado{â€“ac:#4fc87a}.ac-follow_up{â€“ac:#f0a050}.ac-atendimento_humano{â€“ac:#f05050}
.ac-orcamento_pendente{â€“ac:#0ea5e9}.ac-pedido_atrasado{â€“ac:#f05050}.ac-pedido_cancelado{â€“ac:#f05050}
.ac-falha_entrega{â€“ac:#f97316}.ac-pedido_aprovado{â€“ac:#4fc87a}.ac-outros{â€“ac:#a855f7}

/* â”€â”€ PEDIDOS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.ped-status-pendente{â€“ps:#f0a050}.ped-status-aprovado{â€“ps:#0ea5e9}
.ped-status-em_transito{â€“ps:#a855f7}.ped-status-entregue{â€“ps:#4fc87a}
.ped-status-atrasado{â€“ps:#f05050}.ped-status-cancelado{â€“ps:#f05050}.ped-status-falha_entrega{â€“ps:#f97316}
.ped-card{display:flex;align-items:center;gap:12px;padding:14px 0;border-bottom:1px solid var(â€“bb);transition:background .15s}
.ped-card:last-child{border:none}
.ped-num{font-family:var(â€“FM);font-size:11px;color:var(â€“brand);background:var(â€“dim);border:1px solid var(â€“brand);border-radius:6px;padding:3px 8px;flex-shrink:0}
.ped-info{flex:1;min-width:0}
.ped-cliente{font-size:14px;font-weight:500;margin-bottom:2px}
.ped-meta{font-size:11px;color:var(â€“muted)}
.ped-val{font-family:var(â€“FM);font-size:13px;font-weight:500;color:var(â€“ok);flex-shrink:0;text-align:right}
.ped-status-badge{display:inline-flex;align-items:center;padding:2px 9px;border-radius:99px;font-size:10px;font-family:var(â€“FM);letter-spacing:.06em;text-transform:uppercase;background:color-mix(in srgb,var(â€“ps) 12%,transparent);border:1px solid color-mix(in srgb,var(â€“ps) 30%,transparent);color:var(â€“ps)}

/* â”€â”€ EQUIPE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.eq-card{display:flex;align-items:center;gap:12px;padding:12px 0;border-bottom:1px solid var(â€“bb)}
.eq-card:last-child{border:none}
.eq-rank{width:26px;height:26px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-family:var(â€“FM);font-size:12px;font-weight:500;flex-shrink:0}
.eq-rank.top{background:var(â€“dim);border:1px solid var(â€“brand);color:var(â€“brand)}
.eq-rank.other{background:var(â€“bs);border:1px solid var(â€“bb);color:var(â€“muted)}
.eq-info{flex:1;min-width:0}
.eq-name{font-size:14px;font-weight:500;margin-bottom:3px}
.eq-prog{display:flex;align-items:center;gap:8px}
.eq-pct{font-family:var(â€“FM);font-size:10px;width:32px;text-align:right;flex-shrink:0}

/* â”€â”€ TOAST â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.toast{position:fixed;bottom:22px;right:22px;z-index:999;background:rgba(15,15,26,.95);border:1px solid var(â€“bb);border-radius:var(â€“rs);padding:11px 16px;font-size:13px;font-family:var(â€“FM);transform:translateY(16px);opacity:0;transition:all .3s;pointer-events:none}
.toast.show{transform:translateY(0);opacity:1}
.toast.ok{border-color:rgba(79,200,122,.4);color:var(â€“ok)}
.toast.er{border-color:rgba(240,80,80,.4);color:var(â€“err)}

/* â”€â”€ MISC â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
@keyframes pulse{0%,100%{opacity:.3}50%{opacity:1}}
.dot{display:inline-block;width:6px;height:6px;border-radius:50%;background:var(â€“brand);animation:pulse 1s ease-in-out infinite}
.empty{text-align:center;padding:40px;color:var(â€“muted);font-size:13px}
.empty i{display:block;font-size:28px;margin-bottom:10px;font-style:normal}

/* â”€â”€ RESPONSIVE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
@media(max-width:768px){
.topbar{display:flex}
.sidebar{transform:translateX(-100%);top:0}
.sidebar.open{transform:translateX(0)}
.s-overlay{display:block;opacity:0;pointer-events:none}
.s-overlay.open{opacity:1;pointer-events:all}
.main{margin-left:0;padding:72px 14px 24px}
.app{height:auto;min-height:100vh;overflow:visible}
html,body{overflow:auto}
.g4{grid-template-columns:1fr 1fr}
.g3{grid-template-columns:1fr 1fr}
.g2{grid-template-columns:1fr}
.funil{grid-template-columns:repeat(3,1fr)}
.page-ti{font-size:30px}
.dp{width:100%;border-left:none;border-top:1px solid var(â€“bb)}
.modal{width:calc(100vw - 28px);padding:22px}
.fr{grid-template-columns:1fr}
.row-meta .badge:not(:first-child){display:none}
}
@media(max-width:440px){
.g4{grid-template-columns:1fr}
.funil{grid-template-columns:1fr 1fr}
}
</style>

</head>
<body class="t-braavos">

<!-- â”€â”€ LOGIN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->

<div id="login-screen">
  <div class="orb orb1"></div><div class="orb orb2"></div>
  <div class="login-box">
    <div class="login-logo"><span style="color:var(--gold)">B</span><span style="color:var(--brand)" id="l-brand">raavos</span></div>
    <div class="login-sub" id="l-sub">Sales Intelligence Â· Login</div>
    <div class="lbl">Email</div>
    <input type="email" class="linp" id="l-email" placeholder="seu@email.com"/>
    <div class="lbl">Senha</div>
    <input type="password" class="linp" id="l-pw" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢"/>
    <button class="lbtn" id="l-btn" onclick="doLogin()">Entrar</button>
    <div class="lerr" id="l-err"></div>
  </div>
</div>

<!-- â”€â”€ MOBILE TOPBAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->

<div class="topbar">
  <button class="burger" id="burger" onclick="toggleSidebar()">
    <span></span><span></span><span></span>
  </button>
  <div class="t-logo"><span class="tg">B</span><span class="tr" id="tb-brand">raavos</span></div>
  <span class="nbadge hide" id="tb-badge">0</span>
</div>
<div class="s-overlay" id="s-overlay" onclick="toggleSidebar()"></div>

<!-- â”€â”€ APP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->

<div class="app">
  <div class="orb orb1"></div><div class="orb orb2"></div>

  <div class="sidebar" id="sidebar">
    <div class="s-logo">
      <div><span class="sg">B</span><span class="sr" id="sb-brand">raavos</span></div>
      <small id="sb-tag">Sales Intelligence</small>
    </div>
    <div class="nav active" onclick="go('dashboard',this)"><i class="nav-ic">â¬¡</i> Dashboard</div>
    <div class="nav" onclick="go('leads',this)"><i class="nav-ic">â—ˆ</i> Leads</div>
    <div class="nav" id="nav-clientes" onclick="go('clientes',this)"><i class="nav-ic">â—‰</i> Clientes</div>
    <div class="nav" onclick="go('visitas',this)"><i class="nav-ic">â—</i> Visitas</div>
    <div class="nav" onclick="go('pedidos',this)"><i class="nav-ic">â—«</i> Pedidos</div>
    <div class="nav" id="nav-equipe" onclick="go('equipe',this)" style="display:none"><i class="nav-ic">âŠ•</i> Equipe</div>
    <div class="nav" onclick="go('relatorios',this)"><i class="nav-ic">â—«</i> RelatÃ³rios</div>
    <div class="nav" onclick="go('alertas',this)">
      <i class="nav-ic">â—¬</i> Alertas
      <span class="nbadge hide" id="sb-badge">0</span>
    </div>
    <div class="nav-spacer"></div>
    <div class="nav" onclick="toggleTheme()" id="theme-btn"><i class="nav-ic">â—‘</i> <span id="theme-label">Modo Claro</span></div>
    <div id="powered-by" style="padding:8px 22px 4px;font-family:var(--FM);font-size:9px;color:var(--muted);letter-spacing:.08em">powered by <span style="color:var(--brand)">Braavos</span></div>
    <div id="btn-instalar" class="nav" onclick="instalarApp()" style="display:none;color:var(--brand)"><i class="nav-ic">âŠ•</i> Instalar App</div>
    <div style="padding:0 10px">
      <div class="s-user">
        <div style="display:flex;align-items:center;gap:9px;margin-bottom:8px">
          <div id="sb-avatar" style="width:32px;height:32px;border-radius:8px;background:var(--dim);border:1px solid var(--brand);display:flex;align-items:center;justify-content:center;font-family:var(--FD);font-size:16px;color:var(--brand);flex-shrink:0;overflow:hidden">?</div>
          <div>
            <div class="s-user-name" id="sb-nome">â€”</div>
            <div class="s-user-role" id="sb-cargo">â€”</div>
          </div>
        </div>
        <div style="display:flex;gap:6px;align-items:center">
          <label style="font-family:var(--FM);font-size:10px;color:var(--muted);cursor:pointer;transition:color .2s" onmouseover="this.style.color='var(--brand)'" onmouseout="this.style.color='var(--muted)'">
            â—ˆ foto
            <input type="file" accept="image/*" style="display:none" onchange="uploadAvatar(this)"/>
          </label>
          <span style="color:var(--bb)">Â·</span>
          <span class="s-logout" onclick="doLogout()">â†ª sair</span>
        </div>
      </div>
    </div>
  </div>

  <div class="main">

```
<!-- DASHBOARD -->
<div id="page-dashboard" class="page">
  <div class="page-ey" id="d-ey">â€”</div>
  <div class="page-ti" id="d-hi">Bem-vindo ğŸ‘‹</div>

  <!-- KPIs -->
  <div class="g4">
    <div class="card shine"><div class="m-lbl">Total Leads</div><div class="m-val" id="d-total" style="color:var(--brand)">â€”</div><div class="m-sub" id="d-total-s">â€”</div></div>
    <div class="card shine"><div class="m-lbl">Novos (mÃªs)</div><div class="m-val" id="d-novos">â€”</div><div class="m-sub">este mÃªs</div></div>
    <div class="card shine"><div class="m-lbl">Taxa ConversÃ£o</div><div class="m-val" id="d-conv" style="color:var(--ok)">â€”</div><div class="m-sub">lead â†’ ganho</div></div>
    <div class="card shine"><div class="m-lbl">Em NegociaÃ§Ã£o</div><div class="m-val" id="d-neg" style="color:var(--warn)">â€”</div><div class="m-sub">em andamento</div></div>
  </div>

  <!-- META GAUGE + FUNIL GRÃFICO -->
  <div class="g2" style="margin-bottom:18px">
    <div>
      <div class="sh"><div class="sh-t">Meta do MÃªs</div></div>
      <div class="card" style="display:flex;flex-direction:column;align-items:center;padding:20px 16px">
        <div style="position:relative;width:160px;height:90px;overflow:hidden">
          <canvas id="chart-gauge" width="160" height="160" style="position:absolute;top:0;left:0"></canvas>
        </div>
        <div id="gauge-label" style="font-family:var(--FD);font-size:28px;color:var(--brand);margin-top:4px">â€”</div>
        <div style="font-size:11px;color:var(--muted);margin-top:2px" id="gauge-sub">de meta atingida</div>
        <div id="gauge-detail" style="margin-top:12px;display:flex;gap:12px;justify-content:center;flex-wrap:wrap"></div>
      </div>
    </div>
    <div>
      <div class="sh"><div class="sh-t">Funil de Leads</div><span class="sh-l" onclick="go('leads',navEl(1))">Ver todos â†’</span></div>
      <div class="card" style="padding:16px">
        <canvas id="chart-funil" height="140"></canvas>
        <div id="funil-detail" style="display:flex;gap:6px;flex-wrap:wrap;margin-top:10px;justify-content:center"></div>
      </div>
    </div>
  </div>

  <!-- EVOLUÃ‡ÃƒO MENSAL -->
  <div class="sh"><div class="sh-t">EvoluÃ§Ã£o Mensal</div></div>
  <div class="card" style="padding:16px;margin-bottom:18px">
    <canvas id="chart-evolucao" height="120"></canvas>
    <div id="evolucao-detail" style="display:flex;gap:16px;flex-wrap:wrap;margin-top:12px;padding-top:10px;border-top:1px solid rgba(255,255,255,.06)"></div>
  </div>

  <!-- PRÃ“XIMOS CONTATOS + POR ORIGEM -->
  <div class="g2">
    <div>
      <div class="sh"><div class="sh-t">PrÃ³ximos Contatos</div></div>
      <div class="card" id="d-prox"><div class="empty"><div class="dot"></div></div></div>
    </div>
    <div>
      <div class="sh"><div class="sh-t">Por Origem</div></div>
      <div class="card" id="d-orig"><div class="empty"><div class="dot"></div></div></div>
    </div>
  </div>

  <!-- Hidden elements for compatibility -->
  <div style="display:none">
    <span id="f-novo"></span><span id="f-qual"></span><span id="f-neg"></span>
    <span id="f-ganho"></span><span id="f-perd"></span>
  </div>
</div>

<!-- RELATÃ“RIOS -->
<div id="page-relatorios" class="page" style="display:none">
  <div class="page-ey">Insights</div>
  <div class="page-ti">RelatÃ³rios</div>

  <!-- Tabs -->
  <div style="display:flex;gap:6px;margin-bottom:18px;flex-wrap:wrap">
    <span class="chip on" id="rtab-diario" onclick="relTab('diario')">â— DiÃ¡rio</span>
    <span class="chip" id="rtab-mensal" onclick="relTab('mensal')">â—« Mensal</span>
    <span id="rtab-gerente-wrap">
      <span class="chip" id="rtab-gerente" onclick="relTab('gerente')">âŠ• Equipe</span>
    </span>
  </div>

  <!-- DIÃRIO -->
  <div id="rel-diario">
    <div class="g4" style="margin-bottom:14px">
      <div class="card shine"><div class="m-lbl">Visitas Hoje</div><div class="m-val" id="rd-visitas" style="color:var(--brand)">â€”</div><div class="m-sub">realizadas</div></div>
      <div class="card shine"><div class="m-lbl">Leads Criados</div><div class="m-val" id="rd-leads">â€”</div><div class="m-sub">hoje</div></div>
      <div class="card shine"><div class="m-lbl">Alertas</div><div class="m-val" id="rd-alertas" style="color:var(--warn)">â€”</div><div class="m-sub">pendentes</div></div>
      <div class="card shine"><div class="m-lbl">Follow-ups</div><div class="m-val" id="rd-followups" style="color:var(--err)">â€”</div><div class="m-sub">vencidos</div></div>
    </div>
    <div class="sh"><div class="sh-t">Visitas do Dia</div></div>
    <div class="card" id="rd-visitas-list"><div class="empty"><i>â—</i>Nenhuma visita hoje.</div></div>
    <div class="sh" style="margin-top:14px"><div class="sh-t">Leads Criados Hoje</div></div>
    <div class="card" id="rd-leads-list"><div class="empty"><i>â—ˆ</i>Nenhum lead hoje.</div></div>
  </div>

  <!-- MENSAL -->
  <div id="rel-mensal" style="display:none">
    <div style="display:flex;align-items:center;gap:10px;margin-bottom:16px">
      <button class="btn btn-g btn-sm" onclick="relMes(-1)">â†</button>
      <div style="font-family:var(--FD);font-size:20px;letter-spacing:.06em;flex:1;text-align:center" id="rm-mes-label">â€”</div>
      <button class="btn btn-g btn-sm" onclick="relMes(1)">â†’</button>
    </div>
    <div class="g4" style="margin-bottom:14px">
      <div class="card shine"><div class="m-lbl">Leads Criados</div><div class="m-val" id="rm-leads" style="color:var(--brand)">â€”</div><div class="m-sub">no mÃªs</div></div>
      <div class="card shine"><div class="m-lbl">Leads Ganhos</div><div class="m-val" id="rm-ganhos" style="color:var(--ok)">â€”</div><div class="m-sub">fechados</div></div>
      <div class="card shine"><div class="m-lbl">Visitas</div><div class="m-val" id="rm-visitas">â€”</div><div class="m-sub">realizadas</div></div>
      <div class="card shine"><div class="m-lbl">ConversÃ£o</div><div class="m-val" id="rm-conv" style="color:var(--warn)">â€”</div><div class="m-sub">do mÃªs</div></div>
    </div>
    <div class="sh"><div class="sh-t">Meta vs Realizado</div></div>
    <div class="card" style="padding:16px;margin-bottom:14px">
      <canvas id="chart-meta-mensal" height="120"></canvas>
      <div id="meta-detail" style="display:flex;gap:12px;flex-wrap:wrap;margin-top:12px;padding-top:10px;border-top:1px solid rgba(255,255,255,.06)"></div>
    </div>
    <div class="sh"><div class="sh-t">Leads por Status</div></div>
    <div class="card" style="padding:16px">
      <canvas id="chart-status-mensal" height="140"></canvas>
    </div>
  </div>

  <!-- GERENTE / EQUIPE -->
  <div id="rel-gerente" style="display:none">
    <div style="display:flex;align-items:center;gap:10px;margin-bottom:16px">
      <button class="btn btn-g btn-sm" onclick="relMesG(-1)">â†</button>
      <div style="font-family:var(--FD);font-size:20px;letter-spacing:.06em;flex:1;text-align:center" id="rg-mes-label">â€”</div>
      <button class="btn btn-g btn-sm" onclick="relMesG(1)">â†’</button>
    </div>
    <div class="sh"><div class="sh-t">Ranking do MÃªs</div></div>
    <div class="card" style="padding:16px;margin-bottom:14px">
      <canvas id="chart-ranking" height="160"></canvas>
    </div>
    <div class="sh"><div class="sh-t">Visitas por Vendedor</div></div>
    <div class="card" style="padding:16px">
      <canvas id="chart-visitas-equipe" height="140"></canvas>
    </div>
  </div>
</div>

<!-- LEADS -->
<div id="page-leads" class="page" style="display:none">
  <div class="page-ey">Pipeline</div>
  <div class="page-ti">Leads</div>
  <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap;margin-bottom:14px">
    <div class="fbar" style="margin:0;flex:1">
      <input class="fsearch" id="lead-q" placeholder="Buscar nome ou empresa..." oninput="renderLeads()"/>
      <span class="chip on" data-s="todos" onclick="chipLead(this)">Todos</span>
      <span class="chip" data-s="novo" onclick="chipLead(this)">Novo</span>
      <span class="chip" data-s="qualificando" onclick="chipLead(this)">Qualificando</span>
      <span class="chip" data-s="aguardando_cliente" onclick="chipLead(this)">Aguardando</span>
      <span class="chip" data-s="pronto_para_compra" onclick="chipLead(this)">Pronto</span>
      <span class="chip" data-s="em_negociacao" onclick="chipLead(this)">NegociaÃ§Ã£o</span>
      <span class="chip" data-s="fechado_ganho" onclick="chipLead(this)">Ganho</span>
      <span class="chip" data-s="fechado_perdido" onclick="chipLead(this)">Perdido</span>
    </div>
    <button class="btn btn-p btn-sm" onclick="openM('m-lead')">â—ˆ Novo Lead</button>
  </div>
  <div class="card" id="leads-list"><div class="empty"><div class="dot"></div></div></div>
</div>

<!-- CLIENTES -->
<div id="page-clientes" class="page" style="display:none">
  <div class="page-ey">Carteira</div>
  <div class="page-ti">Clientes</div>
  <div class="g2" id="clientes-grid"><div class="empty" style="grid-column:1/-1"><div class="dot"></div></div></div>
</div>

<!-- VISITAS -->
<div id="page-visitas" class="page" style="display:none">
  <div class="page-ey">Campo</div>
  <div class="page-ti">Visitas</div>
  <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:18px;flex-wrap:wrap;gap:10px">
    <div style="display:flex;gap:6px">
      <span class="chip on" id="vtab-roteiro" onclick="visTab('roteiro')">â—± Roteiro</span>
      <span class="chip" id="vtab-historico" onclick="visTab('historico')">â— HistÃ³rico</span>
    </div>
    <button class="btn btn-p btn-sm" id="btn-nova-visita" onclick="openM('m-visita')" style="display:none">â— Registrar Visita</button>
  </div>

  <!-- ABA ROTEIRO -->
  <div id="vis-roteiro">
    <div class="card" style="margin-bottom:14px">
      <div style="display:flex;align-items:center;gap:12px;flex-wrap:wrap">
        <div>
          <div class="m-lbl">Data do Roteiro</div>
          <input type="date" class="fi" id="rot-data" style="margin-top:4px;width:160px" onchange="loadRoteiro()"/>
        </div>
        <div style="flex:1"></div>
        <button class="btn btn-g btn-sm" onclick="abrirMaps()">â†— Abrir no Maps</button>
        <button class="btn btn-p btn-sm" onclick="salvarRoteiro()">â—ˆ Salvar Roteiro</button>
      </div>
    </div>

    <!-- SugestÃµes -->
    <div class="sh"><div class="sh-t">â—¬ SugestÃµes</div><span class="sh-l" onclick="toggleSugestoes()">ver todas â†’</span></div>
    <div class="card" id="rot-sugestoes" style="margin-bottom:14px"><div class="empty"><div class="dot"></div></div></div>

    <!-- Lista do roteiro -->
    <div class="sh">
      <div class="sh-t">â—± Paradas do Dia</div>
      <button class="btn btn-g btn-sm" onclick="openAddParada()">+ Adicionar</button>
    </div>
    <div class="card" id="rot-lista"><div class="empty"><i>â—±</i>Nenhuma parada adicionada ainda.</div></div>
  </div>

  <!-- ABA HISTÃ“RICO -->
  <div id="vis-historico" style="display:none">
    <div style="display:flex;justify-content:flex-end;margin-bottom:12px">
      <button class="btn btn-p btn-sm" onclick="openM('m-visita')">â— Registrar Visita</button>
    </div>
    <div class="card" id="visitas-list"><div class="empty"><div class="dot"></div></div></div>
  </div>
</div>

<!-- PEDIDOS -->
<div id="page-pedidos" class="page" style="display:none">
  <div class="page-ey">Acompanhamento</div>
  <div class="page-ti">Pedidos</div>
  <div class="fbar">
    <span class="chip on" data-s="todos" onclick="chipPed(this)">Todos</span>
    <span class="chip" data-s="pendente" onclick="chipPed(this)">Pendente</span>
    <span class="chip" data-s="aprovado" onclick="chipPed(this)">Aprovado</span>
    <span class="chip" data-s="em_transito" onclick="chipPed(this)">Em TrÃ¢nsito</span>
    <span class="chip" data-s="entregue" onclick="chipPed(this)">Entregue</span>
    <span class="chip" data-s="atrasado" onclick="chipPed(this)">Atrasado</span>
    <span class="chip" data-s="cancelado" onclick="chipPed(this)">Cancelado</span>
  </div>
  <div class="card" id="pedidos-list"><div class="empty"><div class="dot"></div></div></div>
</div>

<!-- EQUIPE (gerente only) -->
<div id="page-equipe" class="page" style="display:none">
  <div class="page-ey">GestÃ£o</div>
  <div class="page-ti">Equipe</div>
  <div class="g3" style="margin-bottom:20px">
    <div class="card shine"><div class="m-lbl">Vendedores</div><div class="m-val" id="eq-tot" style="color:var(--brand)">â€”</div><div class="m-sub">ativos</div></div>
    <div class="card shine"><div class="m-lbl">Leads Ganhos</div><div class="m-val" id="eq-gan" style="color:var(--ok)">â€”</div><div class="m-sub">total da equipe</div></div>
    <div class="card shine"><div class="m-lbl">Visitas</div><div class="m-val" id="eq-vis">â€”</div><div class="m-sub">total da equipe</div></div>
  </div>
  <div class="g2">
    <div>
      <div class="sh"><div class="sh-t">â—ˆ Ranking Leads</div></div>
      <div class="card" id="eq-rl"><div class="empty"><div class="dot"></div></div></div>
    </div>
    <div>
      <div class="sh"><div class="sh-t">â— Ranking Visitas</div></div>
      <div class="card" id="eq-rv"><div class="empty"><div class="dot"></div></div></div>
    </div>
  </div>
  <div class="sh" style="margin-top:6px"><div class="sh-t">âŠ• Vendedores</div></div>
  <div class="g2" id="eq-grid"><div class="empty" style="grid-column:1/-1"><div class="dot"></div></div></div>
</div>

<!-- ALERTAS -->
<div id="page-alertas" class="page" style="display:none">
  <div class="page-ey">NotificaÃ§Ãµes</div>
  <div class="page-ti">Alertas</div>
  <div style="display:flex;justify-content:flex-end;margin-bottom:18px">
    <button class="btn btn-g btn-sm" onclick="marcarTodos()">âœ“ Marcar todos como lidos</button>
  </div>
  <div class="ag-ti"><span>ğŸ‰</span> Pedidos Fechados</div>
  <div id="al-fechados"><div class="empty"><div class="dot"></div></div></div>
  <div class="ag-ti" style="margin-top:24px"><span>â—¬</span> AtenÃ§Ã£o</div>
  <div id="al-atencao"><div class="empty"><div class="dot"></div></div></div>
</div>
```

  </div><!-- /main -->
</div><!-- /app -->

<!-- â”€â”€ DETAIL PANEL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->

<div class="dpov" id="dpov" onclick="closeDP()"></div>
<div class="dp" id="dp">
  <button class="dp-cl" onclick="closeDP()">âœ•</button>
  <div id="dp-body"></div>
</div>

<!-- â”€â”€ MODAL: NOVO LEAD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->

<div class="ov" id="m-lead">
  <div class="modal">
    <button class="mcl" onclick="closeM('m-lead')">âœ•</button>
    <div class="modal-ti">â—ˆ Novo Lead</div>
    <div class="check-row" id="lead-is-cliente-row">
      <input type="checkbox" id="lead-is-cliente"/>
      <label for="lead-is-cliente">JÃ¡ Ã© cliente (promover automaticamente)</label>
    </div>
    <div class="msec">Contato</div>
    <div class="fr">
      <div class="fg"><label class="fl">Nome *</label><input type="text" class="fi" id="l-nome" placeholder="Nome completo"/></div>
      <div class="fg"><label class="fl">Empresa</label><input type="text" class="fi" id="l-emp" placeholder="Empresa Ltda"/></div>
    </div>
    <div class="fr">
      <div class="fg"><label class="fl">Telefone</label><input type="text" class="fi" id="l-tel" placeholder="(11) 99999-9999"/></div>
      <div class="fg"><label class="fl">Email</label><input type="email" class="fi" id="l-email" placeholder="contato@empresa.com"/></div>
    </div>
    <div class="fr">
      <div class="fg"><label class="fl">Cargo</label><input type="text" class="fi" id="l-cargo" placeholder="Diretor, Gerente..."/></div>
      <div class="fg"><label class="fl">CNPJ</label><input type="text" class="fi" id="l-cnpj" placeholder="00.000.000/0001-00"/></div>
    </div>
    <div class="msec">ClassificaÃ§Ã£o</div>
    <div class="fr">
      <div class="fg"><label class="fl">Status</label>
        <select class="fs" id="l-status">
          <option value="novo">Novo</option>
          <option value="qualificando">Qualificando</option>
          <option value="aguardando_cliente">Aguardando Cliente</option>
          <option value="pronto_para_compra">Pronto para Compra</option>
          <option value="em_negociacao">Em NegociaÃ§Ã£o</option>
          <option value="fechado_ganho">Fechado Ganho</option>
          <option value="fechado_perdido">Fechado Perdido</option>
        </select>
      </div>
      <div class="fg"><label class="fl">Prioridade</label>
        <select class="fs" id="l-prio">
          <option value="normal">Normal</option>
          <option value="alta">Alta</option>
          <option value="baixa">Baixa</option>
          <option value="vip">VIP</option>
        </select>
      </div>
    </div>
    <div class="fr">
      <div class="fg"><label class="fl">Segmento</label>
        <select class="fs" id="l-seg"><option value="">Selecionar</option><option>Tecnologia</option><option>LogÃ­stica</option><option>Financeiro</option><option>SaÃºde</option><option>Varejo</option><option>IndÃºstria</option><option>Outro</option></select>
      </div>
      <div class="fg"><label class="fl">Origem</label>
        <select class="fs" id="l-orig"><option value="">Selecionar</option><option>IndicaÃ§Ã£o</option><option>Cold Call</option><option>LinkedIn</option><option>Site</option><option>Evento</option><option>WhatsApp</option><option>Outro</option></select>
      </div>
    </div>
    <div class="msec">LocalizaÃ§Ã£o &amp; Agenda</div>
    <div class="fr">
      <div class="fg"><label class="fl">Cidade</label><input type="text" class="fi" id="l-cid" placeholder="SÃ£o Paulo"/></div>
      <div class="fg"><label class="fl">Estado</label><input type="text" class="fi" id="l-est" placeholder="SP" maxlength="2"/></div>
    </div>
    <div class="fr">
      <div class="fg"><label class="fl">RegiÃ£o</label><input type="text" class="fi" id="l-reg" placeholder="Sul, Norte..."/></div>
      <div class="fg"><label class="fl">PrÃ³ximo Contato</label><input type="date" class="fi" id="l-prox"/></div>
    </div>
    <div class="fg"><label class="fl">Notas</label><textarea class="fta" id="l-notas" placeholder="Contexto, observaÃ§Ãµes..."></textarea></div>
    <div class="mfoot">
      <button class="btn btn-g" onclick="closeM('m-lead')">Cancelar</button>
      <button class="btn btn-p" onclick="salvarLead()">Salvar Lead</button>
    </div>
  </div>
</div>

<!-- â”€â”€ MODAL: ADICIONAR PARADA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->

<div class="ov" id="m-parada">
  <div class="modal" style="width:420px">
    <button class="mcl" onclick="closeM('m-parada')">âœ•</button>
    <div class="modal-ti">â—± Adicionar Parada</div>
    <div style="display:flex;gap:6px;margin-bottom:14px">
      <span class="chip on" id="ptab-lead" onclick="ptab('lead')">â—ˆ Lead</span>
      <span class="chip" id="ptab-cliente" onclick="ptab('cliente')">â—‰ Cliente</span>
    </div>
    <div id="p-section-lead" class="fg"><label class="fl">Lead</label><select class="fs" id="p-lead-sel"></select></div>
    <div id="p-section-cliente" class="fg" style="display:none"><label class="fl">Cliente</label><select class="fs" id="p-cliente-sel"></select></div>
    <div class="mfoot">
      <button class="btn btn-g" onclick="closeM('m-parada')">Cancelar</button>
      <button class="btn btn-p" onclick="addParada()">Adicionar ao Roteiro</button>
    </div>
  </div>
</div>

<!-- â”€â”€ MODAL: REGISTRAR VISITA DO ROTEIRO â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->

<div class="ov" id="m-check-visita">
  <div class="modal" style="width:420px">
    <button class="mcl" onclick="closeM('m-check-visita')">âœ•</button>
    <div class="modal-ti">â— Registrar Visita</div>
    <input type="hidden" id="cv-cliente-id"/>
    <input type="hidden" id="cv-parada-idx"/>
    <div id="cv-nome" style="font-size:14px;color:var(--muted);margin-bottom:16px">â€”</div>
    <div class="fr">
      <div class="fg"><label class="fl">Resultado</label>
        <select class="fs" id="cv-resultado">
          <option value="">Selecionar</option>
          <option value="positivo">Positivo</option>
          <option value="neutro">Neutro</option>
          <option value="negativo">Negativo</option>
        </select>
      </div>
      <div class="fg"><label class="fl">DuraÃ§Ã£o (min)</label>
        <input type="number" class="fi" id="cv-duracao" placeholder="30"/>
      </div>
    </div>
    <div class="fg"><label class="fl">Resumo *</label>
      <textarea class="fta" id="cv-resumo" placeholder="O que aconteceu na visita?"></textarea>
    </div>
    <div class="fg"><label class="fl">PrÃ³ximo Passo</label>
      <input type="text" class="fi" id="cv-proximo" placeholder="Ex: Enviar proposta"/>
    </div>
    <div class="check-row">
      <input type="checkbox" id="cv-pedido"/>
      <label for="cv-pedido">Gerou pedido nesta visita</label>
    </div>
    <div class="mfoot">
      <button class="btn btn-g" onclick="closeM('m-check-visita')">Cancelar</button>
      <button class="btn btn-ok" onclick="concluirVisita()">âœ“ Marcar como Visitado</button>
    </div>
  </div>
</div>

<!-- â”€â”€ MODAL: NOVA VISITA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->

<div class="ov" id="m-visita">
  <div class="modal">
    <button class="mcl" onclick="closeM('m-visita')">âœ•</button>
    <div class="modal-ti">â— Nova Visita</div>
    <div style="display:flex;gap:6px;margin-bottom:14px">
      <span class="chip on" id="vtab-cliente" onclick="vtab('cliente')">â—‰ Cliente</span>
      <span class="chip" id="vtab-lead" onclick="vtab('lead')">â—ˆ Lead</span>
    </div>
    <div id="v-section-cliente" class="fg"><label class="fl">Cliente</label><select class="fs" id="v-cliente"></select></div>
    <div id="v-section-lead" class="fg" style="display:none"><label class="fl">Lead</label><select class="fs" id="v-lead-sel"></select></div>
    <div class="fr">
      <div class="fg"><label class="fl">Tipo</label>
        <select class="fs" id="v-tipo">
          <option value="presencial">â¬¡ Presencial</option>
          <option value="remota">â—ˆ Remota</option>
          <option value="ligacao">â—‰ LigaÃ§Ã£o</option>
        </select>
      </div>
      <div class="fg"><label class="fl">Data</label><input type="date" class="fi" id="v-data"/></div>
    </div>
    <div class="fr">
      <div class="fg"><label class="fl">Hora</label><input type="time" class="fi" id="v-hora"/></div>
      <div class="fg"><label class="fl">DuraÃ§Ã£o (min)</label><input type="number" class="fi" id="v-duracao" placeholder="60"/></div>
    </div>
    <div class="fg"><label class="fl">Resumo</label><textarea class="fta" id="v-resumo" placeholder="O que aconteceu?"></textarea></div>
    <div class="fg"><label class="fl">PrÃ³ximo Passo</label><input type="text" class="fi" id="v-proximo-passo" placeholder="Ex: Enviar proposta"/></div>
    <div class="fr">
      <div class="fg"><label class="fl">Data Follow-up</label><input type="date" class="fi" id="v-followup"/></div>
      <div class="fg"><label class="fl">Resultado</label>
        <select class="fs" id="v-resultado">
          <option value="">Selecionar</option>
          <option value="positivo">Positivo</option>
          <option value="neutro">Neutro</option>
          <option value="negativo">Negativo</option>
        </select>
      </div>
    </div>
    <div class="check-row">
      <input type="checkbox" id="v-pedido"/>
      <label for="v-pedido">Gerou pedido nesta visita</label>
    </div>
    <div class="mfoot">
      <button class="btn btn-g" onclick="closeM('m-visita')">Cancelar</button>
      <button class="btn btn-p" onclick="salvarVisita()">Registrar</button>
    </div>
  </div>
</div>

<!-- â”€â”€ MODAL: EDITAR META (gerente) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->

<div class="ov" id="m-meta">
  <div class="modal" style="width:380px">
    <button class="mcl" onclick="closeM('m-meta')">âœ•</button>
    <div class="modal-ti">âŠ• Editar Meta</div>
    <div id="m-meta-nome" style="font-size:14px;color:var(--muted);margin-bottom:16px">â€”</div>
    <input type="hidden" id="meta-vid"/>
    <div class="fg"><label class="fl">Meta Mensal â€” Leads Ganhos</label><input type="number" class="fi" id="meta-leads" min="1" max="999"/></div>
    <div class="fg"><label class="fl">Meta Mensal â€” Visitas</label><input type="number" class="fi" id="meta-visitas" min="1" max="999"/></div>
    <div class="mfoot">
      <button class="btn btn-g" onclick="closeM('m-meta')">Cancelar</button>
      <button class="btn btn-p" onclick="salvarMeta()">Salvar Meta</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
// â”€â”€ CONFIG â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const SURL='https://wufkytnlhiscyzatumvc.supabase.co';
const SKEY='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Ind1Zmt5dG5saGlzY3l6YXR1bXZjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA2Nzc5OTcsImV4cCI6MjA4NjI1Mzk5N30.2IdxHQWDPjk4_pW2aNyIob2khIrW5ajYHXKYIIBu2xE';
const sb=supabase.createClient(SURL,SKEY);

let U=null,P=null,allLeads=[],allPedidos=[],pedFilter='todos',leadFilter='todos';

// â”€â”€ EMPRESA (dinÃ¢mico do banco) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let EMPRESA=null;

async function loadEmpresa(){
  if(!P?.empresa_id) return;
  const {data}=await sb.from('empresas').select('*').eq('id',P.empresa_id).single();
  if(!data) return;
  EMPRESA=data;
  applyEmpresa(data);
}

function applyEmpresa(e){
  // Cores dinÃ¢micas
  const root=document.documentElement;
  if(e.cor_primaria){
    root.style.setProperty('--brand',e.cor_primaria);
    const hex=e.cor_primaria.replace('#','');
    const r=parseInt(hex.slice(0,2),16);
    const g=parseInt(hex.slice(2,4),16);
    const b=parseInt(hex.slice(4,6),16);
    root.style.setProperty('--dim',`rgba(${r},${g},${b},0.12)`);
    // Atualiza theme-color do PWA dinamicamente
    const tm=document.querySelector('meta[name="theme-color"]');
    if(tm) tm.content=e.cor_primaria;
  }
  if(e.cor_fundo && !document.body.classList.contains('light')){
    root.style.setProperty('--bg',e.cor_fundo);
    root.style.setProperty('--bg2',e.cor_fundo);
    document.body.style.background=e.cor_fundo;
  }

  // Nome da empresa
  const nome=e.nome||'Braavos';
  const inicial=nome[0].toUpperCase();
  const resto=nome.slice(1);
  ['sb-brand','tb-brand','l-brand'].forEach(id=>{
    const el=document.getElementById(id);if(el)el.textContent=resto;
  });
  // Inicial dourada
  document.querySelectorAll('.sg,.tg,.mg').forEach(el=>el.textContent=inicial);

  // Logo
  if(e.logo_url){
    // Sidebar logo
    const sLogo=document.querySelector('.s-logo');
    if(sLogo){
      sLogo.innerHTML=`<img src="${e.logo_url}" style="height:36px;object-fit:contain;max-width:160px;margin-bottom:4px" onerror="this.style.display='none'"/>
        <small id="sb-tag">Sales Intelligence</small>`;
    }
    // Login logo
    const lLogo=document.querySelector('.login-logo');
    if(lLogo){
      lLogo.innerHTML=`<img src="${e.logo_url}" style="height:48px;object-fit:contain;max-width:200px;margin-bottom:8px"/>`;
    }
    // Mobile logo
    const tLogo=document.querySelector('.t-logo');
    if(tLogo){
      tLogo.innerHTML=`<img src="${e.logo_url}" style="height:28px;object-fit:contain;max-width:120px"/>`;
    }
  }

  // Tagline
  const stag=document.getElementById('sb-tag');if(stag)stag.textContent='Sales Intelligence';
  const lsub=document.getElementById('l-sub');if(lsub)lsub.textContent=nome+' Â· Login';
  document.title=nome+' â€” Sales Intelligence';

  // Powered by Braavos
  const pb=document.getElementById('powered-by');
  if(pb) pb.style.display=e.mostrar_powered===false?'none':'block';
}

// â”€â”€ AUTH â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function doLogin(){
  const email=document.getElementById('l-email').value.trim();
  const pw=document.getElementById('l-pw').value;
  const btn=document.getElementById('l-btn');
  const err=document.getElementById('l-err');
  err.textContent='';btn.disabled=true;btn.textContent='Entrando...';
  const {data,error}=await sb.auth.signInWithPassword({email,password:pw});
  if(error){err.textContent='Email ou senha incorretos.';btn.disabled=false;btn.textContent='Entrar';}
  else await onLogin(data.user);
}
document.getElementById('l-pw').addEventListener('keydown',e=>{if(e.key==='Enter')doLogin();});

async function onLogin(user){
  U=user;
  const {data:prof}=await sb.from('profiles').select('*').eq('user_id',user.id).single();
  P=prof;
  const nome=P?.nome||user.email.split('@')[0];
  document.getElementById('sb-nome').textContent=nome;
  document.getElementById('sb-cargo').textContent=(P?.cargo||'vendedor')+(P?.regiao?' Â· '+P.regiao:'');
  // Avatar
  const avEl=document.getElementById('sb-avatar');
  if(avEl){
    if(P?.avatar_url){
      avEl.innerHTML=`<img src="${P.avatar_url}" style="width:100%;height:100%;object-fit:cover"/>`;
    } else {
      avEl.textContent=nome[0].toUpperCase();
    }
  }
  const h=new Date().getHours();
  const s=h<12?'Bom dia':h<18?'Boa tarde':'Boa noite';
  document.getElementById('d-hi').textContent=`${s}, ${nome.split(' ')[0]} ğŸ‘‹`;
  document.getElementById('d-ey').textContent=new Date().toLocaleDateString('pt-BR',{month:'long',year:'numeric'});
  // Mostrar Equipe sÃ³ p/ gerente
  if(P?.cargo==='gerente') document.getElementById('nav-equipe').style.display='flex';
  document.getElementById('login-screen').classList.add('hidden');
  pedirPush();
  await loadEmpresa();
  await loadAll();
  setupRT();
}

async function doLogout(){
  await sb.auth.signOut();
  U=null;P=null;allLeads=[];allPedidos=[];
  document.getElementById('login-screen').classList.remove('hidden');
  document.getElementById('l-email').value='';
  document.getElementById('l-pw').value='';
  document.getElementById('l-err').textContent='';
  document.getElementById('l-btn').disabled=false;
  document.getElementById('l-btn').textContent='Entrar';
}
sb.auth.getSession().then(({data:{session}})=>{if(session)onLogin(session.user);});

// â”€â”€ LOAD ALL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadAll(){
  await Promise.all([loadLeads(),loadClientes(),loadVisitas(),loadPedidos(),loadAlertas()]);
  loadDashboard();
  if(P?.cargo==='gerente') loadEquipe();
}

// â”€â”€ DASHBOARD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function loadDashboard(){
  const startMes=new Date(new Date().getFullYear(),new Date().getMonth(),1).toISOString();
  const cnt={};
  ['novo','qualificando','em_negociacao','fechado_ganho','fechado_perdido'].forEach(s=>cnt[s]=allLeads.filter(l=>l.status===s).length);
  document.getElementById('f-novo').textContent=(cnt.novo||0)+(allLeads.filter(l=>l.status==='qualificando'||l.status==='aguardando_cliente'||l.status==='pronto_para_compra').length);
  document.getElementById('f-qual').textContent=allLeads.filter(l=>['qualificando','aguardando_cliente','pronto_para_compra'].includes(l.status)).length;
  document.getElementById('f-neg').textContent=cnt.em_negociacao||0;
  document.getElementById('f-ganho').textContent=cnt.fechado_ganho||0;
  document.getElementById('f-perd').textContent=cnt.fechado_perdido||0;
  const total=allLeads.length;
  const conv=total>0?Math.round(((cnt.fechado_ganho||0)/total)*100):0;
  document.getElementById('d-total').textContent=total;
  document.getElementById('d-total-s').textContent=(cnt.fechado_ganho||0)+' ganhos';
  document.getElementById('d-novos').textContent=allLeads.filter(l=>l.created_at>=startMes).length;
  document.getElementById('d-conv').textContent=conv+'%';
  document.getElementById('d-neg').textContent=cnt.em_negociacao||0;

  // PrÃ³ximos contatos
  const hoje=new Date().toISOString().split('T')[0];
  const em7=new Date(Date.now()+7*864e5).toISOString().split('T')[0];
  const prox=allLeads.filter(l=>l.proximo_contato&&l.proximo_contato>=hoje&&l.proximo_contato<=em7)
    .sort((a,b)=>a.proximo_contato.localeCompare(b.proximo_contato)).slice(0,5);
  const pEl=document.getElementById('d-prox');
  pEl.innerHTML=prox.length?prox.map(l=>`
    <div class="row" onclick="openDP(${esc(l)})">
      <div class="av">${(l.nome||'?')[0].toUpperCase()}</div>
      <div class="row-info"><div class="row-name">${l.nome||'â€”'}</div><div class="row-sub">${l.empresa_cliente||'â€”'}</div></div>
      <div style="text-align:right">
        <div style="font-family:var(--FM);font-size:11px;color:var(--warn)">${fd(l.proximo_contato)}</div>
        ${sBadge(l.status)}
      </div>
    </div>`).join('')
    :'<div class="empty"><i>ğŸ“…</i>Nenhum nos prÃ³ximos 7 dias</div>';

  // Por origem
  const orig={};
  allLeads.forEach(l=>{if(l.origem)orig[l.origem]=(orig[l.origem]||0)+1;});
  const topO=Object.entries(orig).sort((a,b)=>b[1]-a[1]).slice(0,5);
  const maxO=topO[0]?.[1]||1;
  document.getElementById('d-orig').innerHTML=topO.length?topO.map(([o,c])=>`
    <div class="cbar">
      <span class="cbar-lbl">${o}</span>
      <div class="cbar-track"><div class="cbar-fill" style="width:${Math.round(c/maxO*100)}%;background:var(--brand)"></div></div>
      <span class="cbar-val" style="color:var(--brand)">${c}</span>
    </div>`).join('')
    :'<div class="empty"><i>â—ˆ</i>Sem dados ainda</div>';
  // Desenha grÃ¡ficos apÃ³s atualizar dados
  requestAnimationFrame(drawDashboardCharts);
}

// â”€â”€ LEADS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadLeads(){
  const {data}=await sb.from('leads').select('*').order('created_at',{ascending:false});
  allLeads=data||[];renderLeads();
}
function renderLeads(){
  const q=(document.getElementById('lead-q')?.value||'').toLowerCase();
  let f=allLeads;
  if(leadFilter!=='todos')f=f.filter(l=>l.status===leadFilter);
  if(q)f=f.filter(l=>(l.nome||'').toLowerCase().includes(q)||(l.empresa_cliente||'').toLowerCase().includes(q));
  const el=document.getElementById('leads-list');
  el.innerHTML=f.length?f.map(l=>`
    <div class="row" onclick="openDP(${esc(l)})">
      <span class="prio p-${l.prioridade||'media'}"></span>
      <div class="av">${(l.nome||'?')[0].toUpperCase()}</div>
      <div class="row-info">
        <div class="row-name">${l.nome||'â€”'}</div>
        <div class="row-sub">${l.empresa_cliente||'â€”'}${l.cidade?' Â· '+l.cidade:''}</div>
      </div>
      <div class="row-meta">
        ${sBadge(l.status)}
        ${l.origem?`<span class="badge b-dim">${l.origem}</span>`:''}
        ${l.proximo_contato?`<span style="font-family:var(--FM);font-size:10px;color:var(--muted)">â—¬ ${fd(l.proximo_contato)}</span>`:''}
      </div>
    </div>`).join('')
    :'<div class="empty"><i>â—ˆ</i>Nenhum lead encontrado.</div>';
}
function chipLead(el){
  document.querySelectorAll('#page-leads .chip').forEach(c=>c.classList.remove('on'));
  el.classList.add('on');leadFilter=el.dataset.s;renderLeads();
}

// â”€â”€ DETAIL PANEL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openDP(lead){
  if(typeof lead==='string')lead=JSON.parse(lead);
  const hasAI=lead.intent||lead.suggested_next_action||lead.confidence_score!=null;
  document.getElementById('dp-body').innerHTML=`
    <div style="display:flex;gap:7px;flex-wrap:wrap;margin-bottom:18px">
      ${sBadge(lead.status)}
      ${lead.prioridade?`<span class="badge b-${lead.prioridade==='alta'?'err':lead.prioridade==='media'?'warn':'ok'}">${lead.prioridade}</span>`:''}
      ${lead.segmento?`<span class="badge b-dim">${lead.segmento}</span>`:''}
    </div>
    <div class="dp-name">${lead.nome||'â€”'}</div>
    <div class="dp-sub">${lead.empresa_cliente||'â€”'}${lead.cargo_cliente?' Â· '+lead.cargo_cliente:''}</div>
    <div class="dp-acts">
      ${lead.telefone?`<a href="tel:${lead.telefone}" class="btn btn-p btn-sm">â—‰ Ligar</a>`:''}
      ${lead.telefone?`<a href="https://wa.me/55${lead.telefone.replace(/\D/g,'')}" target="_blank" class="btn btn-g btn-sm">â—ˆ WhatsApp</a>`:''}
      ${lead.email?`<a href="mailto:${lead.email}" class="btn btn-g btn-sm">â— Email</a>`:''}
      <button class="btn btn-ok btn-sm" onclick="promoverCliente(getPK(${esc(lead)}))">âŠ• Promover para Cliente</button>
    </div>
    ${hasAI?`
    <div class="dp-sec">âœ¦ InteligÃªncia IA</div>
    ${lead.confidence_score!=null?`<div class="dp-f"><div class="dp-fl">Score de ConfianÃ§a</div><div style="display:flex;align-items:center;gap:9px;margin-top:5px"><div class="ptrack" style="flex:1"><div class="pfill" style="width:${Math.round(lead.confidence_score*100)}%"></div></div><span style="font-family:var(--FM);font-size:11px;color:var(--brand)">${Math.round(lead.confidence_score*100)}%</span></div></div>`:''}
    ${lead.intent?`<div class="dp-f"><div class="dp-fl">IntenÃ§Ã£o</div><span class="ai-chip">${lead.intent}</span></div>`:''}
    ${lead.suggested_next_action?`<div class="dp-f"><div class="dp-fl">PrÃ³xima AÃ§Ã£o Sugerida</div><div class="abox"><span class="abox-ic">ğŸ¤–</span><div><div class="abox-ti">${lead.suggested_next_action}</div></div></div></div>`:''}
    `:''}
    <div class="dp-sec">Contato</div>
    ${lead.telefone?`<div class="dp-f"><div class="dp-fl">Telefone</div><div class="dp-fv">${lead.telefone}</div></div>`:''}
    ${lead.email?`<div class="dp-f"><div class="dp-fl">Email</div><div class="dp-fv">${lead.email}</div></div>`:''}
    ${lead.cnpj?`<div class="dp-f"><div class="dp-fl">CNPJ</div><div class="dp-fv">${lead.cnpj}</div></div>`:''}
    ${lead.cidade||lead.estado?`<div class="dp-f"><div class="dp-fl">LocalizaÃ§Ã£o</div><div class="dp-fv">${[lead.cidade,lead.estado].filter(Boolean).join(' â€” ')}${lead.regiao?' Â· '+lead.regiao:''}</div></div>`:''}
    ${lead.proximo_contato?`
    <div class="dp-sec">Agenda</div>
    <div class="abox"><span class="abox-ic">ğŸ“…</span><div><div class="abox-ti">${fdl(lead.proximo_contato)}</div><div class="abox-su">PrÃ³ximo contato</div></div></div>`:''}
    ${lead.ultima_visita?`<div class="dp-f"><div class="dp-fl">Ãšltima Visita</div><div class="dp-fv">${fdl(lead.ultima_visita)}</div></div>`:''}
    ${lead.notas?`<div class="dp-sec">Notas</div><div style="font-size:13px;color:var(--muted);line-height:1.6">${lead.notas}</div>`:''}
    <div style="margin-top:20px;font-family:var(--FM);font-size:9px;color:var(--muted)">Criado em ${fdl(lead.created_at)}</div>`;
  document.getElementById('dpov').classList.add('open');
  document.getElementById('dp').classList.add('open');
}
function closeDP(){
  document.getElementById('dpov').classList.remove('open');
  document.getElementById('dp').classList.remove('open');
}

// â”€â”€ PROMOVER LEAD â†’ CLIENTE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function promoverCliente(leadId){
  if(!P?.empresa_id){showToast('Empresa nÃ£o identificada','er');return;}
  if(!leadId||leadId==='undefined'){showToast('ID do lead nÃ£o encontrado','er');return;}
  // Verifica se jÃ¡ existe
  const {data:exist}=await sb.from('customers').select('lead_id').eq('lead_id',leadId).maybeSingle();
  if(exist){showToast('Lead jÃ¡ Ã© cliente!','ok');closeDP();return;}
  const {error}=await sb.from('customers').insert({
    lead_id:leadId,empresa_id:P.empresa_id,
    assigned_to:P.vendedor_id,customer_status:'ativo',origem:'app'
  });
  if(error){console.error('Erro promover:',error);showToast('Erro: '+error.message,'er');return;}
  showToast('â—‰ Lead promovido a cliente!','ok');
  closeDP();loadClientes();
}

// â”€â”€ CLIENTES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadClientes(){
  const {data}=await sb.from('customers')
    .select('*, leads(nome,empresa_cliente,telefone,email,segmento,cidade,estado)')
    .eq('empresa_id',P.empresa_id)
    .order('created_at',{ascending:false});
  const el=document.getElementById('clientes-grid');
  if(!data?.length){el.innerHTML='<div class="empty" style="grid-column:1/-1"><i>â—‰</i>Nenhum cliente ainda.</div>';return;}
  const sm={ativo:'b-ok',inativo:'b-dim',prospect:'b-warn'};
  const sl={ativo:'Ativo',inativo:'Inativo',prospect:'Prospect'};
  el.innerHTML=data.map(c=>{
    const l=c.leads||{};
    return `<div class="card click" onclick="">
      <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:12px">
        <div>
          <div style="font-weight:500;margin-bottom:2px">${l.nome||'â€”'}</div>
          <div style="font-size:12px;color:var(--muted)">${l.empresa_cliente||''}</div>
        </div>
        <span class="badge ${sm[c.customer_status]||'b-dim'}">${sl[c.customer_status]||c.customer_status}</span>
      </div>
      <div style="font-size:12px;color:var(--muted);display:flex;gap:10px;flex-wrap:wrap">
        ${l.segmento?`<span>â—ˆ ${l.segmento}</span>`:''}
        ${l.telefone?`<span>â—‰ ${l.telefone}</span>`:''}
        ${l.cidade?`<span>â— ${l.cidade}${l.estado?' â€” '+l.estado:''}</span>`:''}
      </div>
      ${c.total_pedidos>0?`<div style="margin-top:10px;font-family:var(--FM);font-size:10px;color:var(--ok)">â—« ${c.total_pedidos} pedidos Â· R$ ${fval(c.lifetime_value)}</div>`:''}
    </div>`;
  }).join('');
}

// â”€â”€ VISITAS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadVisitas(){
  const {data}=await sb.from('visitas')
    .select('*, customers(leads(nome, empresa_cliente))')
    .order('data',{ascending:false});
  const el=document.getElementById('visitas-list');
  if(!data?.length){el.innerHTML='<div class="empty"><i>â—</i>Nenhuma visita ainda.</div>';return;}
  const icons={presencial:'â¬¡',remota:'â—ˆ',ligacao:'â—‰'};
  const bl={presencial:'b-brand',remota:'b-dim',ligacao:'b-dim'};
  const ll={presencial:'Presencial',remota:'Remota',ligacao:'LigaÃ§Ã£o'};
  const rl={positivo:'b-ok',neutro:'b-dim',negativo:'b-err'};
  el.innerHTML=data.map(v=>{
    const nome=v.customers?.leads?.nome||'â€”';
    const emp=v.customers?.leads?.empresa_cliente||'';
    return `<div style="display:flex;gap:12px;padding:13px 0;border-bottom:1px solid var(--bb)">
      <div class="av" style="border-color:var(--bb);background:var(--bs2);color:var(--muted)">${icons[v.tipo]||'â—'}</div>
      <div style="flex:1;min-width:0">
        <div style="font-size:14px;font-weight:500;margin-bottom:2px">${nome}${emp?' <span style="color:var(--muted);font-size:12px">Â· '+emp+'</span>':''}</div>
        <div style="font-size:12px;color:var(--muted);overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${v.resumo||v.proximo_passo||'Sem resumo.'}</div>
      </div>
      <div style="display:flex;flex-direction:column;align-items:flex-end;gap:5px;flex-shrink:0">
        <span style="font-family:var(--FM);font-size:11px;color:var(--muted)">${fd(v.data)}${v.hora?' '+v.hora.slice(0,5):''}</span>
        <span class="badge ${bl[v.tipo]||'b-dim'}">${ll[v.tipo]||v.tipo}</span>
        ${v.resultado?`<span class="badge ${rl[v.resultado]||'b-dim'}">${v.resultado}</span>`:''}
        ${v.pedido_gerado?'<span class="badge b-ok">â—« Pedido</span>':''}
      </div>
    </div>`;
  }).join('');
}

// â”€â”€ PEDIDOS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadPedidos(){
  const q=sb.from('pedidos').select('*, leads(nome,empresa_cliente)').order('created_at',{ascending:false});
  if(P?.cargo!=='gerente') q.eq('vendedor_id',P?.vendedor_id);
  else q.eq('empresa_id',P?.empresa_id);
  const {data}=await q;
  allPedidos=data||[];renderPedidos();
}
function renderPedidos(){
  let f=allPedidos;
  if(pedFilter!=='todos')f=f.filter(p=>p.status===pedFilter);
  const el=document.getElementById('pedidos-list');
  if(!f.length){el.innerHTML='<div class="empty"><i>â—«</i>Nenhum pedido encontrado.</div>';return;}
  const sl={pendente:'Pendente',aprovado:'Aprovado',em_transito:'Em TrÃ¢nsito',entregue:'Entregue',atrasado:'Atrasado',cancelado:'Cancelado',falha_entrega:'Falha'};
  el.innerHTML=f.map(p=>{
    const atrasado=p.status==='pendente'&&p.previsao_entrega&&p.previsao_entrega<new Date().toISOString().split('T')[0];
    return `<div class="ped-card ped-status-${p.status}">
      <div class="ped-num">${p.numero_pedido||'S/N'}</div>
      <div class="ped-info">
        <div class="ped-cliente">${p.leads?.nome||'â€”'}</div>
        <div class="ped-meta">
          ${p.leads?.empresa_cliente?p.leads.empresa_cliente+' Â· ':''}
          ${p.previsao_entrega?'â—¬ '+fd(p.previsao_entrega):''}
          ${atrasado?' âš ï¸ Atrasado':''}
        </div>
      </div>
      <div style="text-align:right">
        <div class="ped-val">R$ ${fval(p.valor_total)}</div>
        <span class="ped-status-badge">${sl[p.status]||p.status}</span>
      </div>
    </div>`;
  }).join('');
}
function chipPed(el){
  document.querySelectorAll('#page-pedidos .chip').forEach(c=>c.classList.remove('on'));
  el.classList.add('on');pedFilter=el.dataset.s;renderPedidos();
}

// â”€â”€ EQUIPE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadEquipe(){
  if(!P?.empresa_id) return;
  const {data:profs}=await sb.from('profiles').select('*').eq('empresa_id',P.empresa_id).eq('ativo',true);
  if(!profs?.length) return;

  const [{data:ganhos},{data:visitas}]=await Promise.all([
    sb.from('leads').select('vendedor_id').eq('empresa_id',P.empresa_id).eq('status','fechado_ganho'),
    sb.from('visitas').select('user_id').in('user_id',profs.map(p=>p.user_id)),
  ]);

  const gPV={};(ganhos||[]).forEach(l=>gPV[l.vendedor_id]=(gPV[l.vendedor_id]||0)+1);
  const uV={};(visitas||[]).forEach(v=>uV[v.user_id]=(uV[v.user_id]||0)+1);
  const u2v={};profs.forEach(p=>u2v[p.user_id]=p.vendedor_id);
  const visPV={};Object.entries(uV).forEach(([uid,c])=>{const vid=u2v[uid];if(vid)visPV[vid]=(visPV[vid]||0)+c;});

  const vendors=profs.filter(p=>p.cargo!=='gerente');
  document.getElementById('eq-tot').textContent=vendors.length||profs.length;
  document.getElementById('eq-gan').textContent=(ganhos||[]).length;
  document.getElementById('eq-vis').textContent=(visitas||[]).length;

  // Ranking leads
  const rkL=[...profs].sort((a,b)=>(gPV[b.vendedor_id]||0)-(gPV[a.vendedor_id]||0));
  const mxL=gPV[rkL[0]?.vendedor_id]||1;
  document.getElementById('eq-rl').innerHTML=rkL.map((p,i)=>{
    const c=gPV[p.vendedor_id]||0,m=p.meta_mensal_leads||20;
    const pct=Math.min(Math.round(c/m*100),100);
    return `<div class="eq-card">
      <div class="eq-rank ${i===0&&c>0?'top':'other'}">${i+1}</div>
      <div class="eq-info">
        <div class="eq-name">${p.nome||'â€”'} ${p.regiao?`<span style="font-size:11px;color:var(--muted)">Â· ${p.regiao}</span>`:''}</div>
        <div class="eq-prog">
          <div class="ptrack" style="flex:1"><div class="pfill" style="width:${Math.round(c/Math.max(mxL,1)*100)}%"></div></div>
          <span class="eq-pct" style="color:${pct>=100?'var(--ok)':pct>=70?'var(--brand)':'var(--muted)'}">${pct}%</span>
        </div>
        <div style="font-size:10px;color:var(--muted);margin-top:2px">${c} de ${m} meta</div>
      </div>
      <span class="badge ${c>0?'b-ok':'b-dim'}">${c}</span>
    </div>`;
  }).join('');

  // Ranking visitas
  const rkV=[...profs].sort((a,b)=>(visPV[b.vendedor_id]||0)-(visPV[a.vendedor_id]||0));
  const mxV=visPV[rkV[0]?.vendedor_id]||1;
  document.getElementById('eq-rv').innerHTML=rkV.map((p,i)=>{
    const c=visPV[p.vendedor_id]||0,m=p.meta_mensal_visitas||30;
    const pct=Math.min(Math.round(c/m*100),100);
    return `<div class="eq-card">
      <div class="eq-rank ${i===0&&c>0?'top':'other'}">${i+1}</div>
      <div class="eq-info">
        <div class="eq-name">${p.nome||'â€”'} ${p.regiao?`<span style="font-size:11px;color:var(--muted)">Â· ${p.regiao}</span>`:''}</div>
        <div class="eq-prog">
          <div class="ptrack" style="flex:1"><div class="pfill" style="width:${Math.round(c/Math.max(mxV,1)*100)}%"></div></div>
          <span class="eq-pct" style="color:${pct>=100?'var(--ok)':'var(--muted)'}">${pct}%</span>
        </div>
        <div style="font-size:10px;color:var(--muted);margin-top:2px">${c} de ${m} meta</div>
      </div>
      <span class="badge ${c>=m?'b-ok':c>0?'b-brand':'b-dim'}">${c}</span>
    </div>`;
  }).join('');

  // Cards vendedores
  document.getElementById('eq-grid').innerHTML=profs.map(p=>{
    const gl=gPV[p.vendedor_id]||0,gv=visPV[p.vendedor_id]||0;
    const ml=p.meta_mensal_leads||20,mv=p.meta_mensal_visitas||30;
    const pl=Math.min(Math.round(gl/ml*100),100),pv=Math.min(Math.round(gv/mv*100),100);
    return `<div class="card">
      <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:13px">
        <div>
          <div style="font-size:14px;font-weight:500;margin-bottom:2px">${p.nome||'â€”'}</div>
          <div style="font-size:11px;color:var(--muted);font-family:var(--FM)">${p.cargo||'vendedor'}${p.regiao?' Â· '+p.regiao:''}</div>
        </div>
        <div style="display:flex;gap:6px;align-items:center">
          <span class="badge ${p.cargo==='gerente'?'b-brand':'b-dim'}">${p.cargo||'vendedor'}</span>
          ${P.cargo==='gerente'?`<button class="btn btn-g btn-sm" onclick="abrirMeta('${p.vendedor_id}','${p.nome||''}',${ml},${mv})">âŠ•</button>`:''}
        </div>
      </div>
      <div style="margin-bottom:9px">
        <div style="display:flex;justify-content:space-between;font-size:11px;margin-bottom:4px">
          <span style="color:var(--muted)">â—ˆ Leads ganhos</span>
          <span style="font-family:var(--FM);color:${pl>=100?'var(--ok)':'var(--brand)'}">${gl}/${ml}</span>
        </div>
        <div class="ptrack"><div class="pfill" style="width:${pl}%;background:${pl>=100?'var(--ok)':'var(--brand)'}"></div></div>
      </div>
      <div>
        <div style="display:flex;justify-content:space-between;font-size:11px;margin-bottom:4px">
          <span style="color:var(--muted)">â— Visitas</span>
          <span style="font-family:var(--FM);color:${pv>=100?'var(--ok)':'var(--muted)'}">${gv}/${mv}</span>
        </div>
        <div class="ptrack"><div class="pfill" style="width:${pv}%;background:${pv>=100?'var(--ok)':'rgba(255,255,255,.2)'}"></div></div>
      </div>
      ${p.whatsapp_pessoal?`<div style="margin-top:11px"><a href="https://wa.me/55${p.whatsapp_pessoal.replace(/\D/g,'')}" target="_blank" class="btn btn-g btn-sm">â—ˆ WhatsApp</a></div>`:''}
    </div>`;
  }).join('');
}

// â”€â”€ META â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function abrirMeta(vid,nome,ml,mv){
  document.getElementById('meta-vid').value=vid;
  document.getElementById('m-meta-nome').textContent=nome;
  document.getElementById('meta-leads').value=ml;
  document.getElementById('meta-visitas').value=mv;
  openM('m-meta');
}
async function salvarMeta(){
  const vid=document.getElementById('meta-vid').value;
  const ml=parseInt(document.getElementById('meta-leads').value);
  const mv=parseInt(document.getElementById('meta-visitas').value);
  if(!ml||!mv){showToast('Preencha os campos','er');return;}

  // Busca valores anteriores
  const {data:curr}=await sb.from('profiles').select('meta_mensal_leads,meta_mensal_visitas').eq('vendedor_id',vid).single();

  // Atualiza profile
  const {error}=await sb.from('profiles').update({meta_mensal_leads:ml,meta_mensal_visitas:mv}).eq('vendedor_id',vid);
  if(error){showToast('Erro: '+error.message,'er');return;}

  // Registra histÃ³rico
  const logs=[];
  if(curr?.meta_mensal_leads!==ml) logs.push({vendedor_id:vid,gerente_id:P.vendedor_id,campo:'meta_mensal_leads',valor_anterior:curr?.meta_mensal_leads,valor_novo:ml});
  if(curr?.meta_mensal_visitas!==mv) logs.push({vendedor_id:vid,gerente_id:P.vendedor_id,campo:'meta_mensal_visitas',valor_anterior:curr?.meta_mensal_visitas,valor_novo:mv});
  if(logs.length) await sb.from('metas_historico').insert(logs);

  closeM('m-meta');showToast('âŠ• Meta atualizada!','ok');loadEquipe();
}

// â”€â”€ ALERTAS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const A_FECHADO=['pedido_fechado','pedido_aprovado'];
const A_ATENCAO=['follow_up','atendimento_humano','orcamento_pendente','pedido_atrasado','pedido_cancelado','falha_entrega','outros'];
const A_IC={pedido_fechado:'ğŸ‰',pedido_aprovado:'â—ˆ',follow_up:'â—¬',atendimento_humano:'âŠ•',orcamento_pendente:'â—«',pedido_atrasado:'â—¬',pedido_cancelado:'â—‰',falha_entrega:'â¬¡',outros:'â—'};
const A_LB={pedido_fechado:'Pedido Fechado',pedido_aprovado:'Pedido Aprovado',follow_up:'Follow Up',atendimento_humano:'Atendimento Humano',orcamento_pendente:'OrÃ§amento Pendente',pedido_atrasado:'Pedido Atrasado',pedido_cancelado:'Pedido Cancelado',falha_entrega:'Falha na Entrega',outros:'AtenÃ§Ã£o'};

async function loadAlertas(){
  if(!P?.vendedor_id) return;
  const {data}=await sb.from('alertas').select('*').eq('vendedor_id',P.vendedor_id).order('criado_em',{ascending:false}).limit(60);
  const al=data||[];
  const nl=al.filter(a=>!a.lido).length;
  updBadge(nl);
  renderGrupo('al-fechados',al.filter(a=>A_FECHADO.includes(a.tipo)||a.tipo==='pedido_fechado'));
  renderGrupo('al-atencao',al.filter(a=>!A_FECHADO.includes(a.tipo)));
}
function renderGrupo(elId,items){
  const el=document.getElementById(elId);if(!el)return;
  el.innerHTML=items.length?items.map(a=>`
    <div class="acard ac-${a.tipo||'outros'} ${a.lido?'lido':''}" onclick="markRead('${a.alerta_id}',this)">
      <div class="a-ic">${A_IC[a.tipo]||'â—'}</div>
      <div class="a-body">
        <div class="a-ti">${a.titulo||A_LB[a.tipo]||'Alerta'}</div>
        <div class="a-msg">${a.mensagem||'â€”'}</div>
        <div class="a-ft">
          <span class="a-time">${timeAgo(a.criado_em)}</span>
          ${!a.lido?'<span class="a-dot"></span>':''}
        </div>
      </div>
    </div>`).join('')
    :'<div class="empty" style="padding:20px;text-align:left;font-size:12px">Nenhum alerta nesta categoria.</div>';
}
async function markRead(id,el){
  if(el.classList.contains('lido'))return;
  el.classList.add('lido');el.querySelector('.a-dot')?.remove();
  await sb.from('alertas').update({lido:true}).eq('alerta_id',id);
  const {count}=await sb.from('alertas').select('*',{count:'exact',head:true}).eq('vendedor_id',P.vendedor_id).eq('lido',false);
  updBadge(count||0);
}
async function marcarTodos(){
  if(!P?.vendedor_id)return;
  await sb.from('alertas').update({lido:true}).eq('vendedor_id',P.vendedor_id).eq('lido',false);
  showToast('Todos marcados como lidos','ok');loadAlertas();
}
function updBadge(n){
  ['sb-badge','tb-badge'].forEach(id=>{
    const b=document.getElementById(id);if(!b)return;
    if(n>0){b.textContent=n>99?'99+':n;b.classList.remove('hide');}
    else b.classList.add('hide');
  });
}

// â”€â”€ SALVAR LEAD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function salvarLead(){
  const nome=document.getElementById('l-nome').value.trim();
  const telefone=document.getElementById('l-tel').value.trim();
  if(!nome){showToast('Informe o nome','er');return;}
  if(!telefone){showToast('Telefone Ã© obrigatÃ³rio','er');return;}
  if(!P?.vendedor_id||!P?.empresa_id){showToast('SessÃ£o invÃ¡lida, faÃ§a login novamente','er');return;}
  const isCliente=document.getElementById('lead-is-cliente').checked;
  const payload={nome,telefone,vendedor_id:P.vendedor_id,empresa_id:P.empresa_id};
  const statusVal=document.getElementById('l-status').value.toLowerCase().trim();
  const validStatus=['novo','qualificando','aguardando_cliente','pronto_para_compra','em_negociacao','fechado_ganho','fechado_perdido'];
  payload.status=isCliente?'fechado_ganho':(validStatus.includes(statusVal)?statusVal:'novo');
  const opt={empresa_cliente:'l-emp',email:'l-email',cargo_cliente:'l-cargo',cnpj:'l-cnpj',cidade:'l-cid',estado:'l-est',regiao:'l-reg',notas:'l-notas',segmento:'l-seg',origem:'l-orig'};
  Object.entries(opt).forEach(([field,elId])=>{const v=document.getElementById(elId)?.value?.trim();if(v)payload[field]=v;});
  // forÃ§a lowercase nos campos com constraints
  if(payload.status) payload.status=payload.status.toLowerCase();
  if(payload.prioridade) payload.prioridade=payload.prioridade.toLowerCase();
  // prioridade: sÃ³ manda se for valor vÃ¡lido
  const prioVal=(document.getElementById('l-prio')?.value||'').toLowerCase().trim();
  const prioNorm=prioVal.toLowerCase().trim();
  payload.prioridade=['baixa','normal','alta','vip'].includes(prioNorm)?prioNorm:'normal';
  const prox=document.getElementById('l-prox').value;
  if(prox)payload.proximo_contato=prox;
  console.log('Inserindo lead via RPC:',payload);
  const {error}=await sb.rpc('inserir_lead',{payload});
  if(error){console.error('Erro lead:',error);showToast('Erro: '+error.message,'er');return;}
  // Se marcou cliente, busca o lead recÃ©m criado
  let leadId=null;
  if(isCliente){
    const {data:novo}=await sb.from('leads')
      .select('id').eq('vendedor_id',P.vendedor_id).eq('nome',nome)
      .order('created_at',{ascending:false}).limit(1).single();
    leadId=novo?.id;
  }

  // Se marcou "jÃ¡ Ã© cliente", promove automaticamente
  if(isCliente && leadId){
    await sb.from('customers').insert({
      lead_id:leadId,empresa_id:P.empresa_id,
      assigned_to:P.vendedor_id,customer_status:'ativo',origem:'app'
    });
    showToast('â—‰ Lead criado e promovido a cliente!','ok');
  } else {
    showToast('â—ˆ Lead salvo!','ok');
  }
  closeM('m-lead');
  // Limpar campos
  ['l-nome','l-emp','l-tel','l-email','l-cargo','l-cnpj','l-cid','l-est','l-reg','l-notas'].forEach(id=>document.getElementById(id).value='');
  document.getElementById('lead-is-cliente').checked=false;
}

// â”€â”€ SALVAR VISITA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let vTabAtual='cliente';
function vtab(t){
  vTabAtual=t;
  document.getElementById('v-section-cliente').style.display=t==='cliente'?'':'none';
  document.getElementById('v-section-lead').style.display=t==='lead'?'':'none';
  document.getElementById('vtab-cliente').classList.toggle('on',t==='cliente');
  document.getElementById('vtab-lead').classList.toggle('on',t==='lead');
}

async function salvarVisita(){
  const dt=document.getElementById('v-data').value;
  if(!dt){showToast('Informe a data','er');return;}

  // Descobre o cliente_id â€” se for lead, busca ou cria o customer
  let clienteId=null;
  if(vTabAtual==='cliente'){
    clienteId=document.getElementById('v-cliente').value;
    if(!clienteId){showToast('Selecione um cliente','er');return;}
  } else {
    // lead selecionado â€” busca se jÃ¡ tem customer, senÃ£o cria
    const leadId=document.getElementById('v-lead-sel').value;
    if(!leadId){showToast('Selecione um lead','er');return;}
    const {data:exist}=await sb.from('customers').select('id').eq('lead_id',leadId).maybeSingle();
    if(exist){
      clienteId=exist.id;
    } else {
      // cria customer automaticamente
      const {data:novo,error:ce}=await sb.from('customers')
        .insert({lead_id:leadId,empresa_id:P.empresa_id,assigned_to:P.vendedor_id,customer_status:'ativo',origem:'app'})
        .select('id').single();
      if(ce){showToast('Erro ao criar cliente: '+ce.message,'er');return;}
      clienteId=novo?.id;
      showToast('â—‰ Lead promovido automaticamente!','ok');
      loadClientes();
    }
  }

  const payload={
    vendedor_id:P.vendedor_id,
    cliente_id:clienteId,
    empresa_id:P.empresa_id,
    tipo:document.getElementById('v-tipo').value,
    data:dt,
    resumo:document.getElementById('v-resumo').value.trim(),
    proximo_passo:document.getElementById('v-proximo-passo').value.trim(),
    resultado:document.getElementById('v-resultado').value,
    pedido_gerado:document.getElementById('v-pedido').checked,
    hora:document.getElementById('v-hora').value,
    duracao_min:document.getElementById('v-duracao').value||'',
    data_followup:document.getElementById('v-followup').value,
  };

  const {error}=await sb.rpc('inserir_visita',{payload});
  if(error){console.error('Erro visita:',error);showToast('Erro: '+error.message,'er');return;}
  closeM('m-visita');
  showToast('â— Visita registrada!','ok');
  ['v-resumo','v-proximo-passo','v-followup'].forEach(id=>{const e=document.getElementById(id);if(e)e.value='';});
  document.getElementById('v-pedido').checked=false;
  document.getElementById('v-resultado').value='';
  loadVisitas();
}

// â”€â”€ REALTIME â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setupRT(){
  sb.channel('rt-main')
    .on('postgres_changes',{event:'*',schema:'public',table:'leads'},()=>loadLeads().then(loadDashboard))
    .on('postgres_changes',{event:'*',schema:'public',table:'customers'},()=>loadClientes())
    .on('postgres_changes',{event:'*',schema:'public',table:'visitas'},()=>loadVisitas())
    .on('postgres_changes',{event:'*',schema:'public',table:'pedidos'},()=>loadPedidos())
    .subscribe();
  if(P?.vendedor_id){
    sb.channel('rt-alertas')
      .on('postgres_changes',{event:'INSERT',schema:'public',table:'alertas',filter:`vendedor_id=eq.${P.vendedor_id}`},
        payload=>{
          tocarSom();
          enviarPush(payload.new.titulo||'Novo Alerta',payload.new.mensagem||'');
          showToast('â—¬ '+(payload.new.titulo||'Novo alerta'),'ok');
          loadAlertas();
        })
      .subscribe();
  }
}

// â”€â”€ MODAIS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openM(id){
  if(id==='m-visita'){
    // Carrega clientes
    sb.from('customers').select('id, leads(nome, empresa_cliente)').eq('empresa_id',P.empresa_id)
      .then(({data})=>{
        const sel=document.getElementById('v-cliente');
        sel.innerHTML=data?.length
          ?data.map(c=>`<option value="${c.id}">${c.leads?.nome||'â€”'}${c.leads?.empresa_cliente?' Â· '+c.leads.empresa_cliente:''}</option>`).join('')
          :'<option value="">Nenhum cliente ainda</option>';
      });
    // Carrega leads
    sb.from('leads').select('id,nome,empresa_cliente').eq('empresa_id',P.empresa_id).order('nome')
      .then(({data})=>{
        const sel=document.getElementById('v-lead-sel');
        sel.innerHTML=data?.length
          ?data.map(l=>`<option value="${l.id}">${l.nome||'â€”'}${l.empresa_cliente?' Â· '+l.empresa_cliente:''}</option>`).join('')
          :'<option value="">Nenhum lead ainda</option>';
      });
    document.getElementById('v-data').value=new Date().toISOString().split('T')[0];
    vtab('cliente');
  }
  document.getElementById(id).classList.add('open');
}
function closeM(id){document.getElementById(id).classList.remove('open');}
document.querySelectorAll('.ov').forEach(o=>o.addEventListener('click',e=>{if(e.target===o)o.classList.remove('open');}));

// â”€â”€ NAV â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function go(page,navEl){
  document.querySelectorAll('[id^="page-"]').forEach(el=>el.style.display='none');
  const t=document.getElementById('page-'+page);
  if(t){t.style.display='block';t.style.animation='none';t.offsetHeight;t.style.animation='pIn .3s ease forwards';}
  document.querySelectorAll('.nav').forEach(el=>el.classList.remove('active'));
  if(navEl)navEl.classList.add('active');
  // fechar sidebar mobile
  document.getElementById('sidebar').classList.remove('open');
  document.getElementById('s-overlay').classList.remove('open');
  document.getElementById('burger').classList.remove('open');
  // carregar pÃ¡gina
  if(page==='alertas')loadAlertas();
  if(page==='equipe')loadEquipe();
  if(page==='relatorios')initRelatorios();
  if(page==='visitas')initRoteiro();
}
function navEl(i){return document.querySelectorAll('.nav')[i];}

// â”€â”€ MOBILE SIDEBAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function toggleSidebar(){
  document.getElementById('sidebar').classList.toggle('open');
  document.getElementById('s-overlay').classList.toggle('open');
  document.getElementById('burger').classList.toggle('open');
}

// â”€â”€ SOM â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function tocarSom(){
  try{
    const ctx=new(window.AudioContext||window.webkitAudioContext)();
    [523,659,784].forEach((f,i)=>{
      const o=ctx.createOscillator(),g=ctx.createGain();
      o.connect(g);g.connect(ctx.destination);o.frequency.value=f;o.type='sine';
      g.gain.setValueAtTime(0,ctx.currentTime+i*.12);
      g.gain.linearRampToValueAtTime(.3,ctx.currentTime+i*.12+.05);
      g.gain.linearRampToValueAtTime(0,ctx.currentTime+i*.12+.25);
      o.start(ctx.currentTime+i*.12);o.stop(ctx.currentTime+i*.12+.3);
    });
  }catch(e){}
}
function pedirPush(){if('Notification' in window&&Notification.permission==='default')Notification.requestPermission();}
function enviarPush(t,b){if('Notification' in window&&Notification.permission==='granted')new Notification(t,{body:b});}

// â”€â”€ UTILS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function fd(d){if(!d)return'â€”';return new Date(d).toLocaleDateString('pt-BR',{day:'2-digit',month:'2-digit'});}
function fdl(d){if(!d)return'â€”';return new Date(d).toLocaleDateString('pt-BR',{day:'2-digit',month:'2-digit',year:'numeric'});}
function fval(v){if(!v)return'0,00';return Number(v).toLocaleString('pt-BR',{minimumFractionDigits:2,maximumFractionDigits:2});}
function esc(o){return JSON.stringify(o).replace(/"/g,'&quot;');}
function timeAgo(d){
  if(!d)return'â€”';const diff=Date.now()-new Date(d).getTime();
  const m=Math.floor(diff/60000);if(m<1)return'agora';if(m<60)return m+'min';
  const h=Math.floor(m/60);if(h<24)return h+'h';
  const dy=Math.floor(h/24);return dy<7?dy+'d':fd(d);
}
// Pega a PK do lead independente do nome do campo
function getPK(lead){
  if(typeof lead==='string') lead=JSON.parse(lead);
  // Tenta campos comuns primeiro
  if(lead.lead_id) return lead.lead_id;
  if(lead.id) return lead.id;
  // Fallback: primeiro UUID que nÃ£o seja empresa/vendedor
  const skip=['empresa_id','vendedor_id'];
  for(const [k,v] of Object.entries(lead)){
    if(!skip.includes(k) && typeof v==='string' && /^[0-9a-f]{8}-/.test(v)) return v;
  }
  return null;
}
function sBadge(s){
  const m={novo:'b-dim',qualificando:'b-blue',aguardando_cliente:'b-warn',pronto_para_compra:'b-brand',em_negociacao:'b-warn',fechado_ganho:'b-ok',fechado_perdido:'b-err'};
  const l={novo:'Novo',qualificando:'Qualificando',aguardando_cliente:'Aguard. Cliente',pronto_para_compra:'Pronto p/ Compra',em_negociacao:'Em NegociaÃ§Ã£o',fechado_ganho:'Ganho',fechado_perdido:'Perdido'};
  return`<span class="badge ${m[s]||'b-dim'}">${l[s]||s||'â€”'}</span>`;
}
// â”€â”€ CHARTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let chartGauge=null,chartFunil=null,chartEvolucao=null;
let chartMetaMensal=null,chartStatusMensal=null,chartRanking=null,chartVisitasEquipe=null;

const CHART_COLORS={
  novo:'rgba(99,102,241,.8)',
  qualificando:'rgba(14,165,233,.8)',
  em_negociacao:'rgba(240,160,80,.8)',
  fechado_ganho:'rgba(79,200,122,.8)',
  fechado_perdido:'rgba(240,80,80,.8)',
  brand:'rgba(201,168,76,.8)',
  brandLine:'#c9a84c',
};

function chartDefaults(){
  return{
    responsive:true,maintainAspectRatio:true,
    plugins:{legend:{display:false},tooltip:{bodyFont:{family:'Outfit'},titleFont:{family:'Outfit'}}},
    scales:{x:{ticks:{color:'rgba(255,255,255,.4)',font:{family:'Outfit',size:11}},grid:{color:'rgba(255,255,255,.05)'}},y:{ticks:{color:'rgba(255,255,255,.4)',font:{family:'Outfit',size:11}},grid:{color:'rgba(255,255,255,.05)'}}}
  };
}

function drawGauge(pct,meta){
  const canvas=document.getElementById('chart-gauge');
  if(!canvas) return;
  const ctx=canvas.getContext('2d');
  const w=160,h=160,cx=80,cy=100,r=65,sw=16;
  ctx.clearRect(0,0,w,h);
  // Track
  ctx.beginPath();ctx.arc(cx,cy,r,Math.PI,2*Math.PI);
  ctx.strokeStyle='rgba(255,255,255,.08)';ctx.lineWidth=sw;ctx.stroke();
  // Fill
  const angle=Math.PI+(Math.min(pct,100)/100)*Math.PI;
  const color=pct>=100?'#4fc87a':pct>=70?'#c9a84c':'#f56565';
  ctx.beginPath();ctx.arc(cx,cy,r,Math.PI,angle);
  ctx.strokeStyle=color;ctx.lineWidth=sw;ctx.lineCap='round';ctx.stroke();
  // Label
  document.getElementById('gauge-label').textContent=Math.round(pct)+'%';
  document.getElementById('gauge-label').style.color=color;
  document.getElementById('gauge-sub').textContent=`${meta} leads de meta`;
  const faltam=Math.max(0,meta-Math.round((pct/100)*meta));
  const atingidos=Math.round((pct/100)*meta);
  const det=document.getElementById('gauge-detail');
  if(det) det.innerHTML=`
    <div style="text-align:center">
      <div style="font-family:var(--FD);font-size:22px;color:var(--ok)">${atingidos}</div>
      <div style="font-size:10px;color:var(--muted);letter-spacing:.06em">ATINGIDOS</div>
    </div>
    <div style="width:1px;background:rgba(255,255,255,.08)"></div>
    <div style="text-align:center">
      <div style="font-family:var(--FD);font-size:22px;color:${faltam===0?'var(--ok)':'var(--err)'}">${faltam}</div>
      <div style="font-size:10px;color:var(--muted);letter-spacing:.06em">FALTAM</div>
    </div>
    <div style="width:1px;background:rgba(255,255,255,.08)"></div>
    <div style="text-align:center">
      <div style="font-family:var(--FD);font-size:22px;color:var(--brand)">${meta}</div>
      <div style="font-size:10px;color:var(--muted);letter-spacing:.06em">META</div>
    </div>`;
}

function drawFunil(counts){
  const canvas=document.getElementById('chart-funil');
  if(!canvas) return;
  if(chartFunil) chartFunil.destroy();
  const labels=['Novo','Qualificando','NegociaÃ§Ã£o','Ganho','Perdido'];
  const data=[counts.novo,counts.qualificando,counts.negociacao,counts.ganho,counts.perdido];
  chartFunil=new Chart(canvas,{
    type:'bar',
    data:{
      labels,
      datasets:[{data,backgroundColor:[CHART_COLORS.novo,CHART_COLORS.qualificando,CHART_COLORS.em_negociacao,CHART_COLORS.fechado_ganho,CHART_COLORS.fechado_perdido],borderRadius:6,borderSkipped:false}]
    },
    options:{...chartDefaults(),indexAxis:'y',plugins:{legend:{display:false}},scales:{x:{ticks:{color:'rgba(255,255,255,.4)',font:{family:'Outfit',size:10}},grid:{color:'rgba(255,255,255,.05)'}},y:{ticks:{color:'rgba(255,255,255,.5)',font:{family:'Outfit',size:11}},grid:{display:false}}}}
  });
  // Detail pills
  const total=data.reduce((a,b)=>a+b,0);
  const det=document.getElementById('funil-detail');
  if(det) det.innerHTML=data.map((v,i)=>`
    <div style="display:flex;align-items:center;gap:5px">
      <div style="width:8px;height:8px;border-radius:2px;background:${[CHART_COLORS.novo,CHART_COLORS.qualificando,CHART_COLORS.em_negociacao,CHART_COLORS.fechado_ganho,CHART_COLORS.fechado_perdido][i]}"></div>
      <span style="font-size:11px;color:var(--muted)">${labels[i]}:</span>
      <span style="font-size:11px;font-weight:600;color:var(--txt)">${v}</span>
      <span style="font-size:10px;color:var(--muted)">(${total?Math.round((v/total)*100):0}%)</span>
    </div>`).join('');
}

async function drawEvolucao(){
  const canvas=document.getElementById('chart-evolucao');
  if(!canvas) return;
  if(chartEvolucao) chartEvolucao.destroy();
  // Busca leads dos Ãºltimos 6 meses
  const meses=[];const labels=[];
  const hoje=new Date();
  for(let i=5;i>=0;i--){
    const d=new Date(hoje.getFullYear(),hoje.getMonth()-i,1);
    meses.push({y:d.getFullYear(),m:d.getMonth()+1});
    labels.push(d.toLocaleDateString('pt-BR',{month:'short',year:'2-digit'}));
  }
  const {data:leads}=await sb.from('leads').select('created_at,status').eq('empresa_id',P.empresa_id);
  const {data:visitas}=await sb.from('visitas').select('data').eq('empresa_id',P.empresa_id);
  const leadsData=meses.map(({y,m})=>(leads||[]).filter(l=>{const d=new Date(l.created_at);return d.getFullYear()===y&&d.getMonth()+1===m}).length);
  const visitasData=meses.map(({y,m})=>(visitas||[]).filter(v=>{const d=new Date(v.data);return d.getFullYear()===y&&d.getMonth()+1===m}).length);
  chartEvolucao=new Chart(canvas,{
    type:'line',
    data:{
      labels,
      datasets:[
        {label:'Leads',data:leadsData,borderColor:CHART_COLORS.brandLine,backgroundColor:'rgba(201,168,76,.1)',tension:.4,fill:true,pointBackgroundColor:CHART_COLORS.brandLine,pointRadius:4},
        {label:'Visitas',data:visitasData,borderColor:'rgba(14,165,233,.8)',backgroundColor:'rgba(14,165,233,.08)',tension:.4,fill:true,pointBackgroundColor:'rgba(14,165,233,.8)',pointRadius:4},
      ]
    },
    options:{...chartDefaults(),plugins:{legend:{display:true,labels:{color:'rgba(255,255,255,.5)',font:{family:'Outfit',size:11},boxWidth:10,padding:16}}}}
  });
  // Totais dos Ãºltimos 6 meses
  const totLeads=leadsData.reduce((a,b)=>a+b,0);
  const totVisitas=visitasData.reduce((a,b)=>a+b,0);
  const melhorMes=Math.max(...leadsData);
  const det=document.getElementById('evolucao-detail');
  if(det) det.innerHTML=`
    <div style="flex:1;min-width:100px">
      <div style="font-size:10px;color:var(--muted);letter-spacing:.08em;text-transform:uppercase;margin-bottom:2px">Total Leads (6 meses)</div>
      <div style="font-family:var(--FD);font-size:24px;color:var(--brand)">${totLeads}</div>
    </div>
    <div style="flex:1;min-width:100px">
      <div style="font-size:10px;color:var(--muted);letter-spacing:.08em;text-transform:uppercase;margin-bottom:2px">Total Visitas (6 meses)</div>
      <div style="font-family:var(--FD);font-size:24px;color:rgba(14,165,233,.9)">${totVisitas}</div>
    </div>
    <div style="flex:1;min-width:100px">
      <div style="font-size:10px;color:var(--muted);letter-spacing:.08em;text-transform:uppercase;margin-bottom:2px">Melhor MÃªs</div>
      <div style="font-family:var(--FD);font-size:24px;color:var(--ok)">${melhorMes} leads</div>
    </div>`;
}

// Desenha grÃ¡ficos do dashboard
function drawDashboardCharts(){
  const counts={
    novo:allLeads.filter(l=>l.status==='novo').length,
    qualificando:allLeads.filter(l=>['qualificando','aguardando_cliente','pronto_para_compra'].includes(l.status)).length,
    negociacao:allLeads.filter(l=>l.status==='em_negociacao').length,
    ganho:allLeads.filter(l=>l.status==='fechado_ganho').length,
    perdido:allLeads.filter(l=>l.status==='fechado_perdido').length,
  };
  drawFunil(counts);
  const meta=P?.meta_mensal_leads||20;
  const hoje=new Date();
  const novosDoMes=allLeads.filter(l=>{const d=new Date(l.created_at);return d.getMonth()===hoje.getMonth()&&d.getFullYear()===hoje.getFullYear();}).length;
  drawGauge((novosDoMes/meta)*100,meta);
  drawEvolucao();
}

// â”€â”€ RELATÃ“RIOS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let relMesAtual=new Date();
let relMesGerenteAtual=new Date();

function relTab(t){
  ['diario','mensal','gerente'].forEach(x=>{
    document.getElementById('rel-'+x).style.display=x===t?'':'none';
    const chip=document.getElementById('rtab-'+x);
    if(chip) chip.classList.toggle('on',x===t);
  });
  if(t==='diario') loadRelDiario();
  if(t==='mensal') loadRelMensal();
  if(t==='gerente') loadRelGerente();
}

function initRelatorios(){
  // Esconde aba gerente se nÃ£o for gerente
  const gw=document.getElementById('rtab-gerente-wrap');
  if(gw) gw.style.display=P?.cargo==='gerente'?'':'none';
  relTab('diario');
}

async function loadRelDiario(){
  const hoje=new Date().toISOString().split('T')[0];
  // Visitas hoje
  const {data:vis}=await sb.from('visitas').select('*, customers(leads(nome,empresa_cliente))')
    .eq('empresa_id',P.empresa_id).eq('vendedor_id',P.vendedor_id).eq('data',hoje);
  document.getElementById('rd-visitas').textContent=(vis||[]).length;
  // Leads hoje
  const {data:leads}=await sb.from('leads').select('id,nome,empresa_cliente,status,created_at')
    .eq('empresa_id',P.empresa_id).eq('vendedor_id',P.vendedor_id)
    .gte('created_at',hoje+'T00:00:00').lte('created_at',hoje+'T23:59:59');
  document.getElementById('rd-leads').textContent=(leads||[]).length;
  // Alertas pendentes
  const {data:alts}=await sb.from('alertas').select('id').eq('empresa_id',P.empresa_id).eq('lido',false);
  document.getElementById('rd-alertas').textContent=(alts||[]).length;
  // Follow-ups vencidos
  const {data:fups}=await sb.from('leads').select('id').eq('empresa_id',P.empresa_id)
    .eq('vendedor_id',P.vendedor_id).lt('proximo_contato',hoje).not('status','in','("fechado_ganho","fechado_perdido")');
  document.getElementById('rd-followups').textContent=(fups||[]).length;
  // Lista visitas
  const elV=document.getElementById('rd-visitas-list');
  elV.innerHTML=(vis||[]).length?(vis||[]).map(v=>`
    <div class="row">
      <div class="av">${v.customers?.leads?.nome?.[0]||'?'}</div>
      <div class="row-info">
        <div class="row-name">${v.customers?.leads?.nome||'â€”'}</div>
        <div class="row-sub">${v.resumo||'Sem resumo'}</div>
      </div>
      <span class="badge ${v.resultado==='positivo'?'b-ok':v.resultado==='negativo'?'b-err':'b-dim'}">${v.resultado||'â€”'}</span>
    </div>`).join(''):'<div class="empty"><i>â—</i>Nenhuma visita hoje.</div>';
  // Lista leads
  const elL=document.getElementById('rd-leads-list');
  elL.innerHTML=(leads||[]).length?(leads||[]).map(l=>`
    <div class="row">
      <div class="av">${l.nome?.[0]||'?'}</div>
      <div class="row-info">
        <div class="row-name">${l.nome||'â€”'}</div>
        <div class="row-sub">${l.empresa_cliente||''}</div>
      </div>
      ${sBadge(l.status)}
    </div>`).join(''):'<div class="empty"><i>â—ˆ</i>Nenhum lead criado hoje.</div>';
}

function relMes(dir){ relMesAtual=new Date(relMesAtual.getFullYear(),relMesAtual.getMonth()+dir,1); loadRelMensal(); }
function relMesG(dir){ relMesGerenteAtual=new Date(relMesGerenteAtual.getFullYear(),relMesGerenteAtual.getMonth()+dir,1); loadRelGerente(); }

async function loadRelMensal(){
  const d=relMesAtual;
  const label=d.toLocaleDateString('pt-BR',{month:'long',year:'numeric'});
  document.getElementById('rm-mes-label').textContent=label.toUpperCase();
  const ini=new Date(d.getFullYear(),d.getMonth(),1).toISOString();
  const fim=new Date(d.getFullYear(),d.getMonth()+1,0,23,59,59).toISOString();
  // Leads do mÃªs
  const {data:leads}=await sb.from('leads').select('id,status,created_at')
    .eq('empresa_id',P.empresa_id).eq('vendedor_id',P.vendedor_id)
    .gte('created_at',ini).lte('created_at',fim);
  // Visitas do mÃªs
  const iniD=ini.split('T')[0];const fimD=fim.split('T')[0];
  const {data:vis}=await sb.from('visitas').select('id')
    .eq('empresa_id',P.empresa_id).eq('vendedor_id',P.vendedor_id)
    .gte('data',iniD).lte('data',fimD);
  const total=(leads||[]).length;
  const ganhos=(leads||[]).filter(l=>l.status==='fechado_ganho').length;
  const conv=total>0?Math.round((ganhos/total)*100):0;
  document.getElementById('rm-leads').textContent=total;
  document.getElementById('rm-ganhos').textContent=ganhos;
  document.getElementById('rm-visitas').textContent=(vis||[]).length;
  document.getElementById('rm-conv').textContent=conv+'%';
  // Chart meta
  const meta=P?.meta_mensal_leads||20;
  const c1=document.getElementById('chart-meta-mensal');
  if(c1){
    if(chartMetaMensal) chartMetaMensal.destroy();
    chartMetaMensal=new Chart(c1,{
      type:'bar',
      data:{
        labels:['Leads Criados','Leads Ganhos','Visitas'],
        datasets:[
          {label:'Realizado',data:[total,ganhos,(vis||[]).length],backgroundColor:[CHART_COLORS.brand,'rgba(79,200,122,.8)','rgba(14,165,233,.8)'],borderRadius:8,barPercentage:.5},
          {label:'Meta',data:[meta,Math.round(meta*.3),P?.meta_mensal_visitas||30],backgroundColor:'rgba(255,255,255,.06)',borderRadius:8,barPercentage:.5},
        ]
      },
      options:{...chartDefaults(),plugins:{legend:{display:true,labels:{color:'rgba(255,255,255,.4)',font:{family:'Outfit',size:11},boxWidth:10}}}}
    });
    // Detail row
    const metaLeads=meta;const metaGanhos=Math.round(meta*.3);const metaVisitas=P?.meta_mensal_visitas||30;
    const det=document.getElementById('meta-detail');
    if(det) det.innerHTML=[
      {label:'Leads Criados',real:total,meta:metaLeads,color:'var(--brand)'},
      {label:'Leads Ganhos',real:ganhos,meta:metaGanhos,color:'var(--ok)'},
      {label:'Visitas',real:(vis||[]).length,meta:metaVisitas,color:'rgba(14,165,233,.9)'},
    ].map(item=>{
      const pct=item.meta>0?Math.round((item.real/item.meta)*100):0;
      const falta=Math.max(0,item.meta-item.real);
      return `<div style="flex:1;min-width:120px;background:rgba(255,255,255,.03);border-radius:10px;padding:10px 12px;border:1px solid rgba(255,255,255,.06)">
        <div style="font-size:10px;color:var(--muted);letter-spacing:.06em;text-transform:uppercase;margin-bottom:6px">${item.label}</div>
        <div style="font-family:var(--FD);font-size:26px;color:${item.color}">${item.real}</div>
        <div style="font-size:11px;color:var(--muted);margin-top:2px">de ${item.meta} â€¢ <span style="color:${pct>=100?'var(--ok)':'var(--err)'}">${pct}%</span></div>
        <div style="font-size:11px;color:var(--muted);margin-top:1px">${falta>0?`Faltam <strong style="color:var(--err)">${falta}</strong>`:'<span style="color:var(--ok)">âœ“ Meta batida!</span>'}</div>
      </div>`;
    }).join('');
  }
  // Chart status
  const statusCounts={novo:0,qualificando:0,em_negociacao:0,fechado_ganho:0,fechado_perdido:0};
  (leads||[]).forEach(l=>{
    if(['qualificando','aguardando_cliente','pronto_para_compra'].includes(l.status)) statusCounts.qualificando++;
    else if(statusCounts[l.status]!==undefined) statusCounts[l.status]++;
  });
  const c2=document.getElementById('chart-status-mensal');
  if(c2){
    if(chartStatusMensal) chartStatusMensal.destroy();
    chartStatusMensal=new Chart(c2,{
      type:'doughnut',
      data:{
        labels:['Novo','Qualificando','NegociaÃ§Ã£o','Ganho','Perdido'],
        datasets:[{data:Object.values(statusCounts),backgroundColor:[CHART_COLORS.novo,CHART_COLORS.qualificando,CHART_COLORS.em_negociacao,CHART_COLORS.fechado_ganho,CHART_COLORS.fechado_perdido],borderWidth:0,hoverOffset:4}]
      },
      options:{responsive:true,maintainAspectRatio:true,plugins:{legend:{display:true,position:'right',labels:{color:'rgba(255,255,255,.5)',font:{family:'Outfit',size:11},boxWidth:10,padding:10}}}}
    });
  }
}

async function loadRelGerente(){
  const d=relMesGerenteAtual;
  const label=d.toLocaleDateString('pt-BR',{month:'long',year:'numeric'});
  document.getElementById('rg-mes-label').textContent=label.toUpperCase();
  const ini=new Date(d.getFullYear(),d.getMonth(),1).toISOString();
  const fim=new Date(d.getFullYear(),d.getMonth()+1,0,23,59,59).toISOString();
  // Busca todos os profiles da empresa
  const {data:profiles}=await sb.from('profiles').select('vendedor_id,nome').eq('empresa_id',P.empresa_id);
  const {data:leads}=await sb.from('leads').select('vendedor_id,status,created_at')
    .eq('empresa_id',P.empresa_id).gte('created_at',ini).lte('created_at',fim);
  const {data:vis}=await sb.from('visitas').select('vendedor_id,data')
    .eq('empresa_id',P.empresa_id)
    .gte('data',ini.split('T')[0]).lte('data',fim.split('T')[0]);
  const nomes=(profiles||[]).map(p=>p.nome?.split(' ')[0]||'â€”');
  const leadsCount=(profiles||[]).map(p=>(leads||[]).filter(l=>l.vendedor_id===p.vendedor_id).length);
  const visitasCount=(profiles||[]).map(p=>(vis||[]).filter(v=>v.vendedor_id===p.vendedor_id).length);
  const c1=document.getElementById('chart-ranking');
  if(c1){
    if(chartRanking) chartRanking.destroy();
    chartRanking=new Chart(c1,{
      type:'bar',
      data:{labels:nomes,datasets:[{label:'Leads',data:leadsCount,backgroundColor:CHART_COLORS.brand,borderRadius:6,barPercentage:.6}]},
      options:{...chartDefaults(),plugins:{legend:{display:false}}}
    });
  }
  const c2=document.getElementById('chart-visitas-equipe');
  if(c2){
    if(chartVisitasEquipe) chartVisitasEquipe.destroy();
    chartVisitasEquipe=new Chart(c2,{
      type:'bar',
      data:{labels:nomes,datasets:[{label:'Visitas',data:visitasCount,backgroundColor:'rgba(14,165,233,.7)',borderRadius:6,barPercentage:.6}]},
      options:{...chartDefaults(),plugins:{legend:{display:false}}}
    });
  }
}

// â”€â”€ ROTEIRO â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let roteiro={data:'',itens:[]};
let roteiroId=null;
let mostrarTodasSugestoes=false;

async function initRoteiro(){
  const hoje=new Date().toISOString().split('T')[0];
  document.getElementById('rot-data').value=hoje;
  await loadRoteiro();
  await loadSugestoes();
}

async function loadRoteiro(){
  const data=document.getElementById('rot-data').value;
  if(!data) return;
  roteiro={data,itens:[]};roteiroId=null;
  const {data:r}=await sb.from('roteiros')
    .select('*').eq('vendedor_id',P.vendedor_id).eq('data',data).maybeSingle();
  if(r){roteiroId=r.id;roteiro.itens=r.itens||[];}
  renderRoteiro();
}

function renderRoteiro(){
  const el=document.getElementById('rot-lista');
  if(!roteiro.itens.length){
    el.innerHTML='<div class="empty"><i>â—±</i>Nenhuma parada. Adicione leads ou clientes abaixo.</div>';
    return;
  }
  el.innerHTML=roteiro.itens.map((item,i)=>`
    <div class="row" style="cursor:default;padding:12px 0" id="parada-${i}">
      <div style="width:24px;height:24px;border-radius:7px;background:var(--dim);border:1px solid var(--brand);display:flex;align-items:center;justify-content:center;font-family:var(--FM);font-size:11px;color:var(--brand);flex-shrink:0">${i+1}</div>
      <div class="av" style="${item.visitado?'background:rgba(79,200,122,.15);border-color:var(--ok);color:var(--ok)':''}">
        ${item.nome?.[0]?.toUpperCase()||'?'}
      </div>
      <div class="row-info">
        <div class="row-name" style="${item.visitado?'text-decoration:line-through;color:var(--muted)':''}">
          ${item.nome||'â€”'}
          <span class="badge ${item.tipo==='cliente'?'b-ok':'b-brand'}" style="margin-left:6px;font-size:9px">${item.tipo}</span>
        </div>
        <div class="row-sub">${item.endereco||'Sem endereÃ§o'}</div>
      </div>
      <div style="display:flex;gap:6px;align-items:center;flex-shrink:0">
        ${item.visitado
          ?'<span class="badge b-ok">âœ“ Visitado</span>'
          :`<button class="btn btn-ok btn-sm" onclick="abrirCheckVisita(${i})">âœ“ Visitar</button>`
        }
        ${item.endereco?`<a href="https://www.google.com/maps/search/${encodeURIComponent(item.endereco)}" target="_blank" class="btn btn-g btn-sm">â†—</a>`:''}
        <button class="btn btn-g btn-sm" onclick="removerParada(${i})" style="padding:5px 8px;color:var(--err)">âœ•</button>
      </div>
    </div>`).join('');
}

async function salvarRoteiro(){
  if(!roteiro.itens.length){showToast('Adicione ao menos uma parada','er');return;}
  if(roteiroId){
    await sb.from('roteiros').update({itens:roteiro.itens}).eq('id',roteiroId);
  } else {
    const {data:r}=await sb.from('roteiros')
      .insert({vendedor_id:P.vendedor_id,empresa_id:P.empresa_id,data:roteiro.data,itens:roteiro.itens})
      .select('id').single();
    if(r) roteiroId=r.id;
  }
  showToast('â—± Roteiro salvo!','ok');
}

async function loadSugestoes(){
  const hoje=new Date().toISOString().split('T')[0];
  const em7=new Date(Date.now()+7*864e5).toISOString().split('T')[0];
  // Leads com proximo_contato vencido ou prÃ³ximo
  const {data:leads}=await sb.from('leads')
    .select('id,nome,empresa_cliente,cidade,estado,prioridade,proximo_contato,status')
    .eq('empresa_id',P.empresa_id)
    .lte('proximo_contato',em7)
    .not('status','in','("fechado_ganho","fechado_perdido")')
    .order('proximo_contato');
  const el=document.getElementById('rot-sugestoes');
  const lista=leads||[];
  const exibir=mostrarTodasSugestoes?lista:lista.slice(0,4);
  if(!exibir.length){el.innerHTML='<div class="empty"><i>â—¬</i>Nenhuma sugestÃ£o no momento.</div>';return;}
  el.innerHTML=exibir.map(l=>{
    const venc=l.proximo_contato&&l.proximo_contato<hoje;
    const end=l.cidade?[l.cidade,l.estado].filter(Boolean).join(' â€” '):'';
    return `<div class="row">
      <span class="prio p-${l.prioridade||'normal'}"></span>
      <div class="av">${l.nome?.[0]?.toUpperCase()||'?'}</div>
      <div class="row-info">
        <div class="row-name">${l.nome||'â€”'}</div>
        <div class="row-sub">${l.empresa_cliente||''}${end?' Â· '+end:''}</div>
      </div>
      <div style="display:flex;gap:6px;align-items:center;flex-shrink:0">
        ${venc?'<span class="badge b-err">Vencido</span>':'<span class="badge b-warn">PrÃ³ximo</span>'}
        <button class="btn btn-p btn-sm" onclick="addSugestao(${JSON.stringify(l).replace(/"/g,"'")})">+ Roteiro</button>
      </div>
    </div>`;
  }).join('');
}

function toggleSugestoes(){
  mostrarTodasSugestoes=!mostrarTodasSugestoes;
  loadSugestoes();
}

function addSugestao(lead){
  if(typeof lead==='string') lead=JSON.parse(lead.replace(/'/g,'"'));
  const end=lead.cidade?[lead.cidade,lead.estado].filter(Boolean).join(', '):'';
  if(roteiro.itens.find(x=>x.id===lead.id)){showToast('JÃ¡ estÃ¡ no roteiro','er');return;}
  roteiro.itens.push({tipo:'lead',id:lead.id,nome:lead.nome,endereco:end,visitado:false});
  renderRoteiro();
  showToast('â—± Adicionado ao roteiro!','ok');
}

function removerParada(i){
  roteiro.itens.splice(i,1);
  renderRoteiro();
}

function abrirCheckVisita(i){
  const item=roteiro.itens[i];
  document.getElementById('cv-cliente-id').value=item.clienteId||'';
  document.getElementById('cv-parada-idx').value=i;
  document.getElementById('cv-nome').textContent=item.nome||'â€”';
  document.getElementById('cv-resumo').value='';
  document.getElementById('cv-proximo').value='';
  document.getElementById('cv-resultado').value='';
  document.getElementById('cv-duracao').value='';
  document.getElementById('cv-pedido').checked=false;
  openM('m-check-visita');
}

async function concluirVisita(){
  const resumo=document.getElementById('cv-resumo').value.trim();
  if(!resumo){showToast('Preencha o resumo','er');return;}
  const i=parseInt(document.getElementById('cv-parada-idx').value);
  const item=roteiro.itens[i];

  // Se for lead, cria/busca customer primeiro
  let clienteId=item.clienteId||null;
  if(item.tipo==='lead'&&!clienteId){
    const {data:exist}=await sb.from('customers').select('id').eq('lead_id',item.id).maybeSingle();
    if(exist){clienteId=exist.id;}
    else{
      const {data:novo}=await sb.from('customers')
        .insert({lead_id:item.id,empresa_id:P.empresa_id,assigned_to:P.vendedor_id,customer_status:'ativo',origem:'app'})
        .select('id').single();
      clienteId=novo?.id;
    }
    roteiro.itens[i].clienteId=clienteId;
  }

  const payload={
    vendedor_id:P.vendedor_id,
    cliente_id:clienteId,
    empresa_id:P.empresa_id,
    tipo:'presencial',
    data:roteiro.data,
    resumo,
    proximo_passo:document.getElementById('cv-proximo').value.trim(),
    resultado:document.getElementById('cv-resultado').value,
    pedido_gerado:document.getElementById('cv-pedido').checked,
    hora:'',
    duracao_min:document.getElementById('cv-duracao').value,
    data_followup:'',
  };
  const {error}=await sb.rpc('inserir_visita',{payload});
  if(error){showToast('Erro: '+error.message,'er');return;}

  // Marca como visitado no roteiro
  roteiro.itens[i].visitado=true;
  await salvarRoteiro();
  renderRoteiro();
  closeM('m-check-visita');
  showToast('âœ“ Visita registrada!','ok');
  loadVisitas();
}

function abrirMaps(){
  const enderecos=roteiro.itens.filter(x=>x.endereco).map(x=>encodeURIComponent(x.endereco));
  if(!enderecos.length){showToast('Nenhum endereÃ§o no roteiro','er');return;}
  if(enderecos.length===1){
    window.open('https://www.google.com/maps/search/'+enderecos[0],'_blank');
  } else {
    const origem=enderecos[0];
    const destino=enderecos[enderecos.length-1];
    const waypoints=enderecos.slice(1,-1).join('/');
    window.open(`https://www.google.com/maps/dir/${origem}${waypoints?'/'+waypoints:''}/${destino}`,'_blank');
  }
}

// Parada modal tabs
let pTabAtual='lead';
function ptab(t){
  pTabAtual=t;
  document.getElementById('p-section-lead').style.display=t==='lead'?'':'none';
  document.getElementById('p-section-cliente').style.display=t==='cliente'?'':'none';
  document.getElementById('ptab-lead').classList.toggle('on',t==='lead');
  document.getElementById('ptab-cliente').classList.toggle('on',t==='cliente');
}

async function openAddParada(){
  // Carrega leads
  const {data:leads}=await sb.from('leads').select('id,nome,empresa_cliente,cidade,estado')
    .eq('empresa_id',P.empresa_id).not('status','in','("fechado_perdido")').order('nome');
  document.getElementById('p-lead-sel').innerHTML=leads?.length
    ?leads.map(l=>`<option value="${l.id}" data-end="${[l.cidade,l.estado].filter(Boolean).join(', ')}" data-nome="${l.nome||''}">${l.nome||'â€”'}${l.empresa_cliente?' Â· '+l.empresa_cliente:''}</option>`).join('')
    :'<option>Nenhum lead</option>';
  // Carrega clientes
  const {data:clis}=await sb.from('customers').select('id,leads(nome,empresa_cliente,cidade,estado)')
    .eq('empresa_id',P.empresa_id);
  document.getElementById('p-cliente-sel').innerHTML=clis?.length
    ?clis.map(c=>`<option value="${c.id}" data-end="${[c.leads?.cidade,c.leads?.estado].filter(Boolean).join(', ')}" data-nome="${c.leads?.nome||''}">${c.leads?.nome||'â€”'}${c.leads?.empresa_cliente?' Â· '+c.leads.empresa_cliente:''}</option>`).join('')
    :'<option>Nenhum cliente</option>';
  ptab('lead');
  openM('m-parada');
}

function addParada(){
  const isLead=pTabAtual==='lead';
  const sel=document.getElementById(isLead?'p-lead-sel':'p-cliente-sel');
  const opt=sel.options[sel.selectedIndex];
  if(!opt?.value){showToast('Selecione um '+(isLead?'lead':'cliente'),'er');return;}
  if(roteiro.itens.find(x=>x.id===opt.value)){showToast('JÃ¡ estÃ¡ no roteiro','er');closeM('m-parada');return;}
  roteiro.itens.push({
    tipo:isLead?'lead':'cliente',
    id:opt.value,
    clienteId:isLead?null:opt.value,
    nome:opt.dataset.nome||opt.text,
    endereco:opt.dataset.end||'',
    visitado:false
  });
  renderRoteiro();
  closeM('m-parada');
  showToast('â—± Adicionado!','ok');
}

function visTab(t){
  document.getElementById('vis-roteiro').style.display=t==='roteiro'?'':'none';
  document.getElementById('vis-historico').style.display=t==='historico'?'':'none';
  document.getElementById('vtab-roteiro').classList.toggle('on',t==='roteiro');
  document.getElementById('vtab-historico').classList.toggle('on',t==='historico');
  if(t==='historico') loadVisitas();
}

// â”€â”€ AVATAR UPLOAD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function uploadAvatar(input){
  const file=input.files[0];
  if(!file) return;
  if(file.size>2*1024*1024){showToast('Foto muito grande (mÃ¡x 2MB)','er');return;}
  const ext=file.name.split('.').pop();
  const path=`avatars/${P.vendedor_id}.${ext}`;
  showToast('Enviando foto...','ok');
  const {error:upErr}=await sb.storage.from('avatars').upload(path,file,{upsert:true});
  if(upErr){showToast('Erro no upload: '+upErr.message,'er');return;}
  const {data:urlData}=sb.storage.from('avatars').getPublicUrl(path);
  const url=urlData.publicUrl;
  await sb.from('profiles').update({avatar_url:url}).eq('vendedor_id',P.vendedor_id);
  P.avatar_url=url;
  const avEl=document.getElementById('sb-avatar');
  if(avEl) avEl.innerHTML=`<img src="${url}" style="width:100%;height:100%;object-fit:cover"/>`;
  showToast('â—ˆ Foto atualizada!','ok');
}

// â”€â”€ TEMA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function toggleTheme(){
  const isLight=document.body.classList.toggle('light');
  localStorage.setItem('theme',isLight?'light':'dark');
  document.getElementById('theme-label').textContent=isLight?'Modo Escuro':'Modo Claro';
  const root=document.documentElement;
  if(isLight){
    // modo claro: remove cor de fundo da empresa, mantÃ©m cor primÃ¡ria
    root.style.removeProperty('--bg');
    root.style.removeProperty('--bg2');
    document.body.style.removeProperty('background');
  } else {
    // modo escuro: reaplica cor de fundo da empresa
    if(EMPRESA?.cor_fundo){
      root.style.setProperty('--bg',EMPRESA.cor_fundo);
      root.style.setProperty('--bg2',EMPRESA.cor_fundo);
      document.body.style.background=EMPRESA.cor_fundo;
    }
  }
}
(()=>{
  if(localStorage.getItem('theme')==='light'){
    document.body.classList.add('light');
    const el=document.getElementById('theme-label');
    if(el) el.textContent='Modo Escuro';
    // garante que cor_fundo da empresa nÃ£o sobrescreve no modo claro
    document.documentElement.style.removeProperty('--bg');
    document.documentElement.style.removeProperty('--bg2');
  }
})();

function showToast(msg,type='ok'){
  const t=document.getElementById('toast');
  t.textContent=msg;t.className=`toast ${type} show`;
  setTimeout(()=>t.classList.remove('show'),3000);
}
</script>

<script>
// â”€â”€ PWA SERVICE WORKER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if('serviceWorker' in navigator){
  window.addEventListener('load',()=>{
    navigator.serviceWorker.register('/sw.js')
      .then(r=>console.log('SW registrado:',r.scope))
      .catch(e=>console.log('SW erro:',e));
  });
}

// Banner de instalaÃ§Ã£o
let deferredPrompt=null;
window.addEventListener('beforeinstallprompt',e=>{
  e.preventDefault();
  deferredPrompt=e;
  // Mostra botÃ£o de instalar na sidebar apÃ³s login
  const btn=document.getElementById('btn-instalar');
  if(btn) btn.style.display='flex';
});
window.addEventListener('appinstalled',()=>{
  deferredPrompt=null;
  const btn=document.getElementById('btn-instalar');
  if(btn) btn.style.display='none';
  showToast('â—ˆ Braavos instalado!','ok');
});
function instalarApp(){
  if(!deferredPrompt) return;
  deferredPrompt.prompt();
  deferredPrompt.userChoice.then(()=>deferredPrompt=null);
}
</script>

</body>
</html>